<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="kZ3lZdC9wn" />
  
  <title>OpenStack Dashboard Load Balance | Technology &amp; Life</title>
  <meta name="author" content="leiqzhang">
  
  <meta name="description" content="Virtualization Related Technologies">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="OpenStack Dashboard Load Balance"/>
  <meta property="og:site_name" content="Technology &amp; Life"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Technology &amp; Life" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40319520-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F6f62dffd0688838f0bc52fc65fd62af4' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Technology &amp; Life</a></h1>
  <h2><a href="/">blog of leiqzhang</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-04-14T15:10:31.000Z"><a href="/2014/04/2014-04-14-openstack-dashboard-load-balance/">Apr 14 2014</a></time>
      
      
  
    <h1 class="title">OpenStack Dashboard Load Balance</h1>
  

    </header>
    <div class="entry">
      
        <h1 id="DashBoard-7684-LoadBalance">DashBoard的LoadBalance</h1>
<h2 id="-95ee-9898-63cf-8ff0-">问题描述</h2>
<p>对于OpenStack的DashBoard来说，为水平扩展其处理能力，就需要对多个DashBoard进行Load Balance。DashBoard和OpenStack各组件对外的API服务不同，其是有状态的，且会涉及特定的问题，本文会对其涉及的问题及解决办法进行分析和记录。</p>
<h2 id="-95ee-9898-5206-6790-">问题分析</h2>
<p>OpenStack的DashBoard对外提供Portal和noVNCProxy两个服务，使用Django框架实现。其中noVNCProxy还涉及到提供websocket服务器的能力。要做到DashBoard的LoadBalance，有如下几个问题需要考虑。</p>
<h3 id="Session_Sticky">Session Sticky</h3>
<p>DashBoard涉及到用户登陆和session管理，当使用多个DashBoard后端做LoadBalance时，需要保持多DashBoard后端session数据的一致性。可以通过将DashBoard所在主机添加到一个memcache集群中，并配置Django使用此memcache来作为session后端来完成这一点。当然，也可以通过由LB软件提供session sticky能力来完成这一点。所谓的session sticky，是指LB需要在第一次接收到请求并分发到后端时，记录其session信息，在后续收到同一个session的请求到来时，将请求转发到相同的后端上。作为L7 Level的LB软件，HAProxy具备session sticky的能力。可通过类似如下Backend配置来开启session sticky：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre>back<span class="operator"><span class="keyword">end</span> dashboard-backend
    mode http
    balance     roundrobin
    cookie SERVERID <span class="keyword">insert</span> indirect nocache
    server  server01 controller01:<span class="number">80</span> <span class="keyword">check</span> cookie server01
    server  server02 controller02:<span class="number">80</span> <span class="keyword">check</span> cookie server02
    server  server03 controller03:<span class="number">80</span> <span class="keyword">check</span> cookie server03</span>
</pre></td></tr></table></figure>

<h3 id="WebSocket">WebSocket</h3>
<p>NoVncProxy服务涉及使用websocket，会对LB软件有如下挑战：</p>
<ol>
<li>LB软件作为反向代理，会对HTTP连接进行监控，并关闭长时间空闲的HTTP连接，而websocket就是作为长连接存在的，故需要LB软件避免错误的关闭websocket；</li>
<li>websocket连接的建立，是首先通过HTTP协议进行握手，然后“Upgrade”而来的，这就需要LB软件可以从HTTP通信中识别到websocket请求，从而正确的对其进行处理；</li>
<li>LB软件需要能够检测各个websocket后端的健康情况，以进行LoadBalance。</li>
</ol>
<p>常用的LB软件HAProxy对websocket提供了相应的支持，对于第一个问题，可通过设置“option http-server-close”来做到，对于第二个问题，HAProxy可以自动检测HTTP的“Upgrade”请求，从而可以识别到websocket连接请求，对于第三个问题，HAProxy本身没有提供支持，不过可以结果业务实际，设置HAProxy的httpchk值，以实现各websocket后端的健康检查。可参考[1]中提到的设置方式。</p>
<h3 id="-5b89-5168-">安全</h3>
<p>DashBoard需要通过public平面提供，从安全角度考虑，需要以HTTPS方式提供服务。而VNCProxy涉及到Websocket，一方面从安全角度考虑，Websocket通信也要采用Secure  Websocket的方式，另一方面，由于VNCProxy页面是作为iframe嵌入到DashBoard的，DashBoard本身是HTTPS方式，也要求了VNCProxy页面以及其发起的Websocket连接必须是HTTPS和Secure Websocket的。下面一节对此问题的解决进行详细说明。</p>
<h2 id="SSL-53cd-5411-4ee3-7406-">SSL反向代理</h2>
<p>上节提到的安全问题需要LB软件可提供对HTTPS和Secure Websocket的支持。当前HAProxy的稳定版本(1.4)尚不直接提供对HTTPS的支持，故这里采用业界比较通用的方式，即作为Backend的DashBoard提供不加密的HTTP和Websocket服务，然后在HAProxy之前再部署一个SSL反向代理(SSL Reverse Proxy)，由此反向代理负责将从frontend接收到的HTTPS信息解密为HTTP信息并传递到backend，将backend发送的HTTP回应加密为HTTPS消息回复到frontend。反向代理提供的这种能力也就是所谓的SSL Termination。</p>
<p>对于SSL反向代理来说，还有一个需要注意的问题就是对Backend发送的301和302 Redirect响应信息的处理。由于作为Backend的DashBoard提供的是HTTP服务，当其发送Redirect响应时，Header中的Location是一个HTTP地址，此时浏览器就会直接跳转到Location地址上，从而会访问HTTP服务。故要么SSL反向代理具有检测并更改Redirect Location的能力，要么配置HTTP服务器对Redirect进行相应的处理。</p>
<p>结合实际的系统部署，SSL反向代理需要作为HA组件(PaceMaker)管理的对象，最好其本身可对外暴露为一个系统服务，以更好的和HA组件进行集成。如前所述，DashBoard实际对外会暴露Portal和noVNCProxy两个服务，这两个服务是独立的后端，需要监听各自不同的端口。</p>
<h2 id="SSL-53cd-5411-4ee3-7406-8f6f-4ef6-5bf9-6bd4-">SSL反向代理软件对比</h2>
<p>当前可提供HTTPS的SSL Termination能力且流行的反向代理软件有Pound、Stunnel和Stud等。其中Stunnel未部署成功，对于Pound和Stud进行了实际部署验证，两者的功能对比如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>Pound</th>
<th>Stud</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTPS的SSL Termination</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Websocket的SSL Termination</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>HTTP Redirection    透明</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>多后端是否暴露一个服务</td>
<td>是</td>
<td>不是</td>
</tr>
<tr>
<td>有无CentOS官方RPM包</td>
<td>无</td>
<td>有</td>
</tr>
</tbody>
</table>
<p>由于Pound不支持Secure Websocket的SSL Termination，故选择Stud。对于上表提到的Stud缺失的功能，进行如下处理：</p>
<ol>
<li>HTTP Redirection可交由后端HTTPD服务器处理，通过配置其Redirect规则和Header的Edit动作，可在HTTPD侧避免直接到HTTP的Redirection</li>
<li>需要二次开发的工作包括RPM包的封装，系统服务的封装，基于Stud不支持一个进程同时对不同后端端口反向代理的能力，这里需要将其封装为两个系统服务，分别代理portal和novncproxy</li>
</ol>
<h2 id="-90e8-7f72-7ed3-6784-">部署结构</h2>
<p>综上，DashBoard的LoadBalance涉及的组件结构图如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre> <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>                        <span class="comment">Browser</span>                              <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
           <span class="comment">|</span>                           <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">HTTPS</span>
           <span class="comment">|</span> <span class="comment">HTTPS</span>               <span class="comment">HTTPS</span> <span class="comment">|</span>          <span class="comment">|</span>      <span class="comment">(Upgrage)</span>
           <span class="comment">v</span>                           <span class="comment">v</span>          <span class="comment">v</span> <span class="comment">WSS</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>             <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>      <span class="comment">Stud</span><span class="literal">-</span><span class="comment">HTTPS</span>   <span class="comment">|</span>             <span class="comment">|</span>     <span class="comment">Stub</span><span class="literal">-</span><span class="comment">Proxy</span>    <span class="comment">|</span>
 <span class="comment">|</span>        <span class="comment">(443)</span>      <span class="comment">|</span>             <span class="comment">|</span>       <span class="comment">(6080)</span>      <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>             <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
           <span class="comment">|</span> <span class="comment">HTTP</span>                 <span class="comment">HTTP</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">WS</span>
           <span class="comment">v</span>                           <span class="comment">v</span>          <span class="comment">v</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>             <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>      <span class="comment">HAProxy</span>      <span class="comment">|</span>             <span class="comment">|</span>      <span class="comment">HAProxy</span>      <span class="comment">|</span>
 <span class="comment">|</span>  <span class="comment">(localhost:80)</span>   <span class="comment">|</span>             <span class="comment">|</span> <span class="comment">(localhost:6080)</span>  <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>             <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
           <span class="comment">|</span> <span class="comment">HTTP</span>                 <span class="comment">HTTP</span> <span class="comment">|</span>          <span class="comment">|</span> <span class="comment">WS</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>                       <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>          <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>                                 <span class="comment">|</span>                          <span class="comment">|</span>
 <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>           <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>    <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|</span>    <span class="comment">Portal01:80</span>  <span class="comment">|</span>           <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|noVncProxy01:6080|</span>&lt;<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>           <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>    <span class="comment">|</span>
 <span class="comment">|</span>                                 <span class="comment">|</span>                          <span class="comment">|</span>
 <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>           <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>    <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|</span>    <span class="comment">Portal02:80</span>  <span class="comment">|</span>           <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|noVncProxy02:6080|</span>&lt;<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
 <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>           <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>    <span class="comment">|</span>
 <span class="comment">|</span>                                 <span class="comment">|</span>                          <span class="comment">|</span>
 <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>           <span class="comment">|</span>   <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>    <span class="comment">|</span>
 <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|</span>    <span class="comment">Portal03:80</span>  <span class="comment">|</span>           <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">|noVncProxy03:6080|</span>&lt;<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
     <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>               <span class="literal">+</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">+</span>
</pre></td></tr></table></figure>

<h2 id="-5177-4f53-914d-7f6e-">具体配置</h2>
<p>首先配置HTTPD，对Dashboard的重定向进行相应的设置，以配合Stud进行使用：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre><span class="comment">#/etc/httpd/conf</span><span class="string">.</span><span class="comment">d/openstack</span><span class="literal">-</span><span class="comment">dashboard</span><span class="literal">-</span><span class="comment">setting</span><span class="string">.</span><span class="comment">conf</span>
<span class="comment">#{public</span><span class="literal">-</span><span class="comment">server</span><span class="literal">-</span><span class="comment">name}:</span> <span class="comment">public</span> <span class="comment">domain</span> <span class="comment">name</span>

<span class="comment">RedirectMatch</span> <span class="comment">permanent</span> <span class="comment">^/$</span> <span class="comment">https://{public</span><span class="literal">-</span><span class="comment">server</span><span class="literal">-</span><span class="comment">name}/dashboard/</span>
<span class="comment">Header</span> <span class="comment">edit</span> <span class="comment">Location</span> <span class="comment">^http://(</span><span class="string">.</span><span class="comment">*)$</span> <span class="comment">https://$1</span>
</pre></td></tr></table></figure>

<p>如下是HAProxy中关于DashBoard相应的配置，其中websocket后端的健康检查尚未实现：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="comment">#</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">#</span> <span class="comment">horizon</span> <span class="comment">frontend</span> <span class="comment">which</span> <span class="comment">proxys</span> <span class="comment">to</span> <span class="comment">the</span> <span class="comment">backends</span>
<span class="comment">#</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">frontend</span>  <span class="comment">dashboard</span> <span class="comment">controller</span><span class="literal">-</span><span class="comment">public:80</span>
    <span class="comment">default_backend</span>             <span class="comment">dashboard</span><span class="literal">-</span><span class="comment">backend</span>

<span class="comment">frontend</span> <span class="comment">novncproxy</span> <span class="comment">controller</span><span class="literal">-</span><span class="comment">public:6080</span>
    <span class="comment">acl</span> <span class="comment">is_websocket</span> <span class="comment">hdr(Upgrade)</span> <span class="literal">-</span><span class="comment">i</span> <span class="comment">WebSocket</span>
    <span class="comment">use_backend</span> <span class="comment">websocket</span><span class="literal">-</span><span class="comment">backend</span> <span class="comment">if</span> <span class="comment">is_websocket</span>
<span class="comment">	</span>
<span class="comment">	default_backend	novncproxy</span><span class="literal">-</span><span class="comment">backend</span>


<span class="comment">#</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">#</span> <span class="comment">round</span> <span class="comment">robin</span> <span class="comment">balancing</span> <span class="comment">between</span> <span class="comment">the</span> <span class="comment">various</span> <span class="comment">backends</span>
<span class="comment">#</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
<span class="comment">backend</span> <span class="comment">dashboard</span><span class="literal">-</span><span class="comment">backend</span>
    <span class="comment">mode</span> <span class="comment">http</span>
    <span class="comment">balance</span>     <span class="comment">roundrobin</span>
    <span class="comment">cookie</span> <span class="comment">SERVERID</span> <span class="comment">insert</span> <span class="comment">indirect</span> <span class="comment">nocache</span>
    <span class="comment">server</span>  <span class="comment">server01</span> <span class="comment">controller01:80</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server01</span>
    <span class="comment">server</span>  <span class="comment">server02</span> <span class="comment">controller02:80</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server02</span>
    <span class="comment">server</span>  <span class="comment">server03</span> <span class="comment">controller03:80</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server03</span>

<span class="comment">backend</span> <span class="comment">websocket</span><span class="literal">-</span><span class="comment">backend</span>
<span class="comment">	mode</span> <span class="comment">http</span>
<span class="comment">	option</span> <span class="comment">forwardfor</span>
<span class="comment">	option</span> <span class="comment">http</span><span class="literal">-</span><span class="comment">server</span><span class="literal">-</span><span class="comment">close</span>
<span class="comment">	option</span> <span class="comment">forceclose</span>
<span class="comment">	no</span> <span class="comment">option</span> <span class="comment">httpclose</span>
<span class="comment">	</span>
<span class="comment">	#TODO:</span> <span class="comment">Add</span> <span class="comment">httpchk</span> <span class="comment">and</span> <span class="comment">rr</span> <span class="comment">support</span> <span class="comment">for</span> <span class="comment">websocket</span><span class="literal">-</span><span class="comment">backend</span>
<span class="comment">	server</span> <span class="comment">app1</span> <span class="comment">controller01:6080</span> <span class="comment">weight</span> <span class="comment">1</span> <span class="comment">maxconn</span> <span class="comment">8192</span> <span class="comment">check</span>

<span class="comment">backend</span> <span class="comment">novncproxy</span><span class="literal">-</span><span class="comment">backend</span>
<span class="comment">	mode</span> <span class="comment">http</span>
<span class="comment">	balance</span>     <span class="comment">roundrobin</span>
    <span class="comment">cookie</span> <span class="comment">SERVERID</span> <span class="comment">insert</span> <span class="comment">indirect</span> <span class="comment">nocache</span>
    <span class="comment">server</span>  <span class="comment">server01</span> <span class="comment">controller01:6080</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server01</span>
    <span class="comment">server</span>  <span class="comment">server02</span> <span class="comment">controller02:6080</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server02</span>
    <span class="comment">server</span>  <span class="comment">server03</span> <span class="comment">controller03:6080</span> <span class="comment">check</span> <span class="comment">cookie</span> <span class="comment">server03</span>
</pre></td></tr></table></figure>

<h2 id="-53c2-8003-8d44-6599-">参考资料</h2>
<ul>
<li>[1] <a href="http://blog.exceliance.fr/2012/11/07/websockets-load-balancing-with-haproxy/" target="_blank">http://blog.exceliance.fr/2012/11/07/websockets-load-balancing-with-haproxy/</a> </li>
</ul>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/OpenStack/">OpenStack</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Horizon/">Horizon</a>, <a href="/tags/HAProxy/">HAProxy</a>, <a href="/tags/Websocket/">Websocket</a>, <a href="/tags/SSL/">SSL</a>
  </div>

        <!-- Baidu Button BEGIN -->
<div id="bdshare" class="bdshare_t bds_tools get-codes-bdshare">
<span class="bds_more">分享到：</span>
<a class="bds_qzone"></a>
<a class="bds_tsina"></a>
<a class="bds_tqq"></a>
<a class="bds_renren"></a>
<a class="bds_t163"></a>
<a class="shareCount"></a>
</div>
<script type="text/javascript" id="bdshare_js" data="type=tools&amp;uid=17824" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000)
</script>
<!-- Baidu Button END -->

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!-- Duoshuo Comment BEGIN -->
    <div class="ds-thread" data-thread-key="/2014/04/2014-04-14-openstack-dashboard-load-balance/" data-author-key="leiqzhang" data-title="OpenStack Dashboard Load Balance"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"leiqzhang"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = 'http://static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
        || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
<!-- Duoshuo Comment END -->
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:leiqzhang.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/OpenStack/">OpenStack</a><small>8</small></li>
  
    <li><a href="/categories/VIM/">VIM</a><small>3</small></li>
  
    <li><a href="/categories/Virtualization/">Virtualization</a><small>16</small></li>
  
    <li><a href="/categories/WordPress/">WordPress</a><small>2</small></li>
  
    <li><a href="/categories/miscellaneous/">miscellaneous</a><small>1</small></li>
  
    <li><a href="/categories/web_dev/">web_dev</a><small>8</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">Tag Cloud</h3>
  <div class="entry">
    <a href="/tags/CIM/" style="font-size: 10.00px;">CIM</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/Cinder/" style="font-size: 10.00px;">Cinder</a><a href="/tags/DBPM/" style="font-size: 10.00px;">DBPM</a><a href="/tags/Deploy/" style="font-size: 10.00px;">Deploy</a><a href="/tags/ELI/" style="font-size: 10.00px;">ELI</a><a href="/tags/Glance/" style="font-size: 10.00px;">Glance</a><a href="/tags/HAProxy/" style="font-size: 10.00px;">HAProxy</a><a href="/tags/Horizon/" style="font-size: 10.00px;">Horizon</a><a href="/tags/IRC/" style="font-size: 10.00px;">IRC</a><a href="/tags/Metadata/" style="font-size: 10.00px;">Metadata</a><a href="/tags/NUMA/" style="font-size: 10.00px;">NUMA</a><a href="/tags/Nova/" style="font-size: 15.00px;">Nova</a><a href="/tags/OPTIONS/" style="font-size: 10.00px;">OPTIONS</a><a href="/tags/Paste/" style="font-size: 10.00px;">Paste</a><a href="/tags/QEMU/" style="font-size: 20.00px;">QEMU</a><a href="/tags/RabbitMQ/" style="font-size: 10.00px;">RabbitMQ</a><a href="/tags/SSL/" style="font-size: 10.00px;">SSL</a><a href="/tags/Stevedore/" style="font-size: 10.00px;">Stevedore</a><a href="/tags/WSGI/" style="font-size: 10.00px;">WSGI</a><a href="/tags/Websocket/" style="font-size: 10.00px;">Websocket</a><a href="/tags/bfc/" style="font-size: 10.00px;">bfc</a><a href="/tags/block-stream/" style="font-size: 10.00px;">block-stream</a><a href="/tags/blockcopy/" style="font-size: 12.50px;">blockcopy</a><a href="/tags/cache/" style="font-size: 10.00px;">cache</a><a href="/tags/css/" style="font-size: 12.50px;">css</a><a href="/tags/dataplane/" style="font-size: 10.00px;">dataplane</a><a href="/tags/device-mapper/" style="font-size: 10.00px;">device-mapper</a><a href="/tags/devstack/" style="font-size: 10.00px;">devstack</a><a href="/tags/ervernote/" style="font-size: 10.00px;">ervernote</a><a href="/tags/etag/" style="font-size: 10.00px;">etag</a><a href="/tags/eval/" style="font-size: 10.00px;">eval</a><a href="/tags/fdisk/" style="font-size: 10.00px;">fdisk</a><a href="/tags/fedora/" style="font-size: 10.00px;">fedora</a><a href="/tags/gpt/" style="font-size: 10.00px;">gpt</a><a href="/tags/greasemonkey/" style="font-size: 10.00px;">greasemonkey</a><a href="/tags/http/" style="font-size: 12.50px;">http</a><a href="/tags/isolinux/" style="font-size: 10.00px;">isolinux</a><a href="/tags/javascript/" style="font-size: 10.00px;">javascript</a><a href="/tags/libvirt/" style="font-size: 17.50px;">libvirt</a>
  </div>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=1644437791&verifier=c45a1931&dpc=1"></iframe>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://blog.csdn.net/luo_brian" title="luo_brian">Luohao</a></li>
<li><a href="http://blog.csdn.net/defeattroy" title="木马屠城">Defeattroy</a></li>
<li><a href="http://www.smilgel.com/" title="听雨轩">MrSaxon</a></li>
<li><a href="http://lanbolee.com/blog/" title="博之博">Rambolee</a></li>
<li><a href="http://www.haoziyanwo.com/" title="耗子燕窝">浩子</a></li>
<li><a href="http://blog.csdn.net/u012815727" title="CloudOS">CloudOS</a></li>
</ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 leiqzhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'leiqzhang';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>