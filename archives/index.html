<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="kZ3lZdC9wn" />
  
  <title>Archives | Technology &amp; Life</title>
  <meta name="author" content="leiqzhang">
  
  <meta name="description" content="Virtualization Related Technologies">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Technology &amp; Life"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="Technology &amp; Life" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40319520-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F6f62dffd0688838f0bc52fc65fd62af4' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Technology &amp; Life</a></h1>
  <h2><a href="/">blog of leiqzhang</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/about">About</a></li>
    
      <li><a href="/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title">Archives</h2>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-27T14:55:31.000Z"><a href="/2014/03/2014-03-27-openstack-irc-meeting-agenda/">Mar 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/2014-03-27-openstack-irc-meeting-agenda/">OpenStack IRC Meeting Agenda</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="OpenStack_IRC_Meeting_Agenda">OpenStack IRC Meeting Agenda</h2>
<p>基于 <a href="https://wiki.openstack.org/wiki/Meetings" target="_blank">https://wiki.openstack.org/wiki/Meetings</a> 整理，时间均为北京时间</p>
<table>
<thead>
<tr>
<th>日期</th>
<th>时间</th>
<th>会议</th>
<th>channel</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>周二</td>
<td>03:00</td>
<td>Ironic team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周二</td>
<td>05:00</td>
<td>Neutron team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周二</td>
<td>21:00</td>
<td>PCI Passthrough</td>
<td>#openstack-meeting-alt</td>
</tr>
<tr>
<td>周二</td>
<td>23:00</td>
<td>Gantt (Nova Scheduler) team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周三</td>
<td>02:00</td>
<td>Keystone team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周三</td>
<td>03:00</td>
<td>TripleO team</td>
<td>#openstack-meeting-alt</td>
</tr>
<tr>
<td>周三</td>
<td>04:00</td>
<td>Technical Committee</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周三</td>
<td>05:00</td>
<td>Project &amp; Release Status</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周四</td>
<td>00:00</td>
<td>Cinder team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周四</td>
<td>00:30</td>
<td>Nova Bug Scrub</td>
<td>#openstack-meeting-3</td>
</tr>
<tr>
<td>周四</td>
<td>03:00</td>
<td>Swift team</td>
<td>#openstack-meeting</td>
</tr>
<tr>
<td>周四</td>
<td>05:00</td>
<td>Ceilometer team</td>
<td>#openstack-meeting</td>
<td>奇数周</td>
</tr>
<tr>
<td>周四</td>
<td>23:00</td>
<td>Ceilometer team</td>
<td>#openstack-meeting</td>
<td>偶数周</td>
</tr>
<tr>
<td>周四</td>
<td>22:00</td>
<td>Nova team</td>
<td>#openstack-meeting-alt</td>
<td>和下面的轮流</td>
</tr>
<tr>
<td>周五</td>
<td>05:00</td>
<td>Nova team</td>
<td>#openstack-meeting</td>
<td>和上面的轮流（最近的一次是14年3月28日）</td>
</tr>
<tr>
<td>周五</td>
<td>08:00</td>
<td>Nova API</td>
<td>#openstack-meeting</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-27T14:52:22.000Z"><a href="/2014/03/tmp-note-1/">Mar 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/tmp-note-1/"></a></h1>
  

    </header>
    <div class="entry">
      
        <h3 id="-7cfb-7edf-90e8-4ef6-9009-578b-">系统部件选型</h3>
<ul>
<li>本地存储使用共享存储方案，ceph、nfs、iscsi，需确定<ul>
<li>对于ceph也要看它作为ephemeral后端，可否利用链接克隆能力：从代码看不是的，但是使用ceph可提供共享存储能力，作为glance后端时可高效download</li>
<li>对于NFS来说，可修改nova配置，使得ephemeral的后端及base的路径均指向NFS，可共享存储，可链接克隆，作为glance后端时可高效download</li>
<li>但Ephemeral的初衷是什么呢？ <a href="https://s3.amazonaws.com/aws001/trailhead/TrailHead_Choosing_the_Right_Data_Storage_Solutions.pdf" target="_blank">https://s3.amazonaws.com/aws001/trailhead/TrailHead_Choosing_the_Right_Data_Storage_Solutions.pdf</a><ul>
<li>Cache.. App Level Replication..Stateless</li>
</ul>
</li>
</ul>
</li>
<li>swift vs ceph<ul>
<li><a href="https://ceph.com/cloud/ceph-and-mirantis-openstack/" target="_blank">https://ceph.com/cloud/ceph-and-mirantis-openstack/</a><ul>
<li>Ceph的问题<ul>
<li>对时钟偏移相当敏感</li>
<li>multisite support，刚刚引入Emperor作为异步同步机制，默认的同步复制机制使其不适合长距离的跨站点场景</li>
<li>block storage density, 当前是2:1 3:1左右，在引入Firefly</li>
<li>Swift API gap，并非100%支持Swift API</li>
</ul>
</li>
<li>部署时的一些问题[ ]通过udev automount rules来使得主机重启后，自动挂载OSD devices and Journals<ul>
<li>ssh互信</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>可考虑选择Swift</li>
</ul>
</li>
<li>qpid / rabbitmq 选型</li>
</ul>
<h3 id="-5f85-786e-5b9a-7684-95ee-9898-">待确定的问题</h3>
<ul>
<li>ceph可否做存储qos</li>
<li>ceph同时对内和对外提供服务，隔离？</li>
<li>S3是否需要单独的网络？</li>
<li>考虑容灾方案</li>
<li>考虑备份方案。现状是无VM级别备份能力。ephemeral盘只支持以glance镜像保存快照方式进行一定程度的支持；cinder提供了卷备份，但对于发放VM时，由于不支持链接克隆，即使可卸载到存储上利用复制卷来做，也会有发放速度限制</li>
</ul>
<h3 id="-53ef-9760-6027-_-26-amp-3b-_-96c6-7fa4-76f8-5173-">可靠性 &amp; 集群相关</h3>
<ul>
<li>计算节点HA：ecavate接口，可一定程度支持HA，但应该是缺乏防脑裂处理的，社区</li>
<li>使用哪个HA软件<ul>
<li>比对：<a href="http://www.slideshare.net/kenhui65/openstack-ha" target="_blank">http://www.slideshare.net/kenhui65/openstack-ha</a><ul>
<li>DBRD有split-brain问题</li>
</ul>
</li>
<li>HAProxy 和 websocket<ul>
<li><a href="http://blog.exceliance.fr/2012/11/07/websockets-load-balancing-with-haproxy/" target="_blank">http://blog.exceliance.fr/2012/11/07/websockets-load-balancing-with-haproxy/</a></li>
<li><a href="http://blog.silverbucket.net/post/31927044856/3-ways-to-configure-haproxy-for-websockets" target="_blank">http://blog.silverbucket.net/post/31927044856/3-ways-to-configure-haproxy-for-websockets</a>  ： 其它的一些websocket检测方式，三种</li>
<li><a href="https://www.exratione.com/2012/07/proxying-websocket-traffic-for-nodejs-the-present-state-of-play/" target="_blank">https://www.exratione.com/2012/07/proxying-websocket-traffic-for-nodejs-the-present-state-of-play/</a> ： haproxy对于ssl也有问题？</li>
<li><a href="http://www.infoq.com/articles/Web-Sockets-Proxy-Servers" target="_blank">http://www.infoq.com/articles/Web-Sockets-Proxy-Servers</a></li>
</ul>
</li>
</ul>
</li>
<li>ceph管理网对网络平面划分的需求</li>
<li>ceph可否用于单机演示，对controller节点数目需求</li>
<li>扩容：ceph扩容，是否中断服务；ceph扩容时，短时间内不能发放业务？</li>
</ul>
<h3 id="-6269-5bb9-_-26-amp-3b-_-53ef-6269-5c55-6027-_-26-amp-3b-_-4e1a-52a1-8fc1-79fb-">扩容 &amp; 可扩展性 &amp; 业务迁移</h3>
<ul>
<li>cell 和 region的应用场景及使用配置，region/cell如何做双活站点</li>
<li>跨rack、idc、site，大规模扩容方案</li>
<li>dashboard的可扩展性（session，websocket）</li>
<li>使用哪个LB软件（和HA软件选型结合）<ul>
<li>Load Balance FAQ: <a href="http://blog.exceliance.fr/loadbalancing-faq/" target="_blank">http://blog.exceliance.fr/loadbalancing-faq/</a></li>
<li>Load Balance Layer 7 session: <a href="http://blog.exceliance.fr/2012/03/29/load-balancing-affinity-persistence-sticky-sessions-what-you-need-to-know/" target="_blank">http://blog.exceliance.fr/2012/03/29/load-balancing-affinity-persistence-sticky-sessions-what-you-need-to-know/</a></li>
</ul>
</li>
</ul>
<h3 id="-5b89-5168-_-26-amp-3b-_-7f51-7edc-">安全 &amp; 网络</h3>
<ul>
<li>spice、vnc agent的安全隔离</li>
<li>各node的防火墙配置、端口开放策略</li>
<li>安全证书等生成</li>
<li>网络平面隔离（在网卡不足时的虚拟vlan方案）</li>
<li>LB时，是否需要俩VIP</li>
<li>安全：ceph的大磁盘时的安全冲击</li>
</ul>
<h3 id="-5347-7ea7-">升级</h3>
<ul>
<li>cell情况下的升级方案</li>
<li>现有OS能力下的升级方案</li>
</ul>
<h3 id="-53ef-7ef4-62a4-6027-">可维护性</h3>
<ul>
<li>系统监控</li>
<li>日志</li>
<li>配置变更和管理</li>
</ul>
<h3 id="-6027-80fd-">性能</h3>
<ul>
<li>keystone考虑，主要是在cell region等情况下的性能</li>
<li>需启用cell/region的规格（触发条件？），以及cell/region各自的规格数据</li>
<li>从性能方面考虑，LB什么情况下应该部署（跨机房，机架，具体规格？）</li>
<li>cell方式的性能问题考虑</li>
<li>ephemeral盘使用的是链接克隆形式，在超过8个时可能会有性能问题</li>
<li>glance性能瓶颈</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-27T14:52:22.000Z"><a href="/2014/03/2014-03-21-openstack-operations-guide-notes/">Mar 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/2014-03-21-openstack-operations-guide-notes/"></a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="OpenStack_Operations_Guide_Notes">OpenStack Operations Guide Notes</h1>
<h2 id="CH1_Provisioning_and_Deployment">CH1 Provisioning and Deployment</h2>
<p>主要关注的是OS infrastructure的自动化部署和配置</p>
<h3 id="-81ea-52a8-5316-90e8-7f72-28-Automated_Deployment-29-">自动化部署(Automated Deployment)</h3>
<p>所谓自动化部署，是指在少量的人工操作（如服务器上架、mac/ip规划、开机等）后，不再需要人工介入，自动化对操作系统进行安装和配置。</p>
<p>对于操作系统的自动化部署来说，一般会首先通过PXE/TFTP的网络启动，然后通过kickstart/preseed等自动配置技术或者直接使用镜像部署的方式来进行。</p>
<p>在进行自动化部署之前，必须对一些关键点进行提前规划和考虑。</p>
<ul>
<li>磁盘分区和RAID：生产环境，一定要考虑RAID</li>
<li>网络配置：保证可PXE启动，不使用bond，不VLAN</li>
</ul>
<h3 id="-81ea-52a8-5316-914d-7f6e-">自动化配置</h3>
<p>Puppet</p>
<h3 id="-8fdc-7a0b-7ba1-7406-">远程管理</h3>
<p>Out-of-band access</p>
<p>IPMI</p>
<h2 id="CH2_Cloud_Controller_Design">CH2 Cloud Controller Design</h2>
<p>假设： 单独的Controller节点</p>
<h3 id="Hardware_Considerations">Hardware Considerations</h3>
<p>Controller上的一些服务是可以虚拟化部署的，如MQ</p>
<p><em>TODO</em> 还有什么？</p>
<p>假设：所有服务都非虚拟化部署</p>
<p><em>问题</em> 根据可预见的规模来决定是否虚拟化部署, 后续扩容怎么办？</p>
<p>考虑如下几点：</p>
<ul>
<li>同时运行的虚拟机数量：数据库大小；数据库水平扩展（虚拟机状态上报、调度）</li>
<li>同时运行的计算节点数量：消息队列</li>
<li>访问API的用户数量：CPU</li>
<li>访问Dashboard的用户数量：CPU</li>
<li>同时运行nova-api服务的数量：size the controller with a core per service</li>
<li>一个虚拟机运行的时间</li>
<li>是否使用外部权限系统:网络；CPU</li>
</ul>
<h3 id="Separation_of_Services">Separation of Services</h3>
<ul>
<li>glance-* 运行于swfit-proxy 服务器</li>
<li>独立的数据库服务器</li>
<li>每个服务均虚拟化部署</li>
<li>使用LB</li>
</ul>
<p>nova-compute、swfit-proxy和swift-object不建议虚拟化部署</p>
<h3 id="Database">Database</h3>
<p>重要依赖。建议cluster database来具有容错能力</p>
<h3 id="MQ">MQ</h3>
<p>重要依赖。建议Cluster MQ</p>
<h3 id="API">API</h3>
<p>是否要提供EC2兼容API？ </p>
<p>可提供多个API server （LB）</p>
<h3 id="Extensions">Extensions</h3>
<h3 id="Scheduler">Scheduler</h3>
<p>可提供多个scheduler （不依赖LB）</p>
<h3 id="Images">Images</h3>
<ul>
<li>glance-api</li>
<li>glance-registry: 维护镜像元数据信息，依赖数据库</li>
</ul>
<p>Backend的选择</p>
<h3 id="Dashboard">Dashboard</h3>
<p>httpd</p>
<h3 id="Authentication_and_Authorization">Authentication and Authorization</h3>
<p>Keystone; Policy</p>
<p>Identity Service Backends:</p>
<ul>
<li>In-memory kv存储</li>
<li>SQL数据库</li>
<li>PAM</li>
<li>LDAP</li>
</ul>
<h3 id="Network_Considerations">Network Considerations</h3>
<p>保证带宽</p>
<p>尤其是Imaging Service在controller时</p>
<p>10GB NIC / bond 2 10GB NICs</p>
<h2 id="Scaling">Scaling</h2>
<h3 id="The_Starting_Point">The Starting Point</h3>
<p>估算cloud的核心数量和规格：虚拟机最大数量 (超配比例 x cores/virtual cores per instance)，所需ephemeral存储容量(flavor disk size * number instance)</p>
<p>还需要考虑oS本身服务所占用资源</p>
<p>还需考虑实际的业务模型，对于实际触发的操作类型的影响，进而对controller等的load</p>
<p>一般来说，8U8G 可制成一个机架的计算节点</p>
<h3 id="Adding_Controller_Nodes">Adding Controller Nodes</h3>
<p>对于只依赖于内部MQ的，可以直接添加服务，如nova-scheduler等等</p>
<p>对于API服务，需要依赖LB （software：Pound or HAProxy)</p>
<p>对于DashBoard，需要考虑websocket和session的共享</p>
<p>对于nova-api, glance-api等，本身可通过配置来使用多进程模式（<em>TODO</em>）</p>
<p>DB/MQ的LB等，需要单独考虑</p>
<h3 id="Segregating_Your_Cloud">Segregating Your Cloud</h3>
<p>cells，regions， zones，host aggregates</p>
<h4 id="Cells_and_Regions">Cells and Regions</h4>
<h4 id="AZ_and_Host_Aggregates">AZ and Host Aggregates</h4>
<h3 id="Scalable_Hardware">Scalable Hardware</h3>
<h4 id="Hardware_Procurement">Hardware Procurement</h4>
<p>CPU同型号，支持迁移</p>
<h4 id="Capacity_Planning">Capacity Planning</h4>
<p>Monitor resource usage</p>
<h4 id="Burn-in_Testing">Burn-in Testing</h4>
<p>Hardware failure</p>
<h2 id="CH4_Compute_Nodes">CH4 Compute Nodes</h2>
<h3 id="CPU_Choice">CPU Choice</h3>
<p>VT / Cores</p>
<h3 id="Hypervisor_Choice">Hypervisor Choice</h3>
<h3 id="Instance_Storage_Solutions">Instance Storage Solutions</h3>
<ul>
<li>Off compute node storage — shared file system</li>
<li>On compute node storage — shared file system</li>
<li>On compute node storage — non-shared file system</li>
</ul>
<p>Live Migration (non-share/share)</p>
<p>Shared Filesystems:</p>
<ul>
<li>NFS</li>
<li>GlusterFS</li>
<li>MooseFS</li>
<li>Lustre</li>
</ul>
<h3 id="Overcommitting">Overcommitting</h3>
<p>默认超配比例： CPU 16， RAM 1.5</p>
<h3 id="Logging">Logging</h3>
<p>Condiser： 中心logging server； 解析和分析系统 (logstash)</p>
<h3 id="Networking">Networking</h3>
<p>see CH6</p>
<h2 id="CH5_Storage_Decisions">CH5 Storage Decisions</h2>
<p>Persistent Storage</p>
<h3 id="Storage_Concepts">Storage Concepts</h3>
<ul>
<li>Object Storage</li>
<li>Block Storage<ul>
<li>直接访问存储块设备</li>
<li>基于文件</li>
</ul>
</li>
<li>File-level Storage： 没有直接呈现，但ephemeral实际就是</li>
</ul>
<h3 id="Chossing_Storage_Back-ends">Chossing Storage Back-ends</h3>
<p>List of Questions</p>
<p>…</p>
<p>各种开源及以cinder-driver提供的商业存储后端的对比</p>
<ul>
<li>Swift</li>
<li>Ceph： cow(fast boot-from-volume); 统一对象和块存储；支持keystone</li>
<li>Gluster： UFO （分布式文件系统+对象存储）</li>
<li>LVM：不支持副本</li>
<li>Sheepdog</li>
</ul>
<h3 id="Notes_on_OpenStack_Object_Storage">Notes on OpenStack Object Storage</h3>
<h2 id="Network_Design">Network Design</h2>
<h4 id="Management_Network">Management Network</h4>
<ul>
<li>避免虚拟机流量影响系统管理和监控</li>
<li>可考虑对openstack各组件内部通信配置单独的网络（VLAN）</li>
</ul>
<h4 id="Public_Addressing_Options">Public Addressing Options</h4>
<ul>
<li>Fixed/Float IP</li>
</ul>
<h4 id="IP_Address_Planning">IP Address Planning</h4>
<p>可分解为一些列的sections:</p>
<ul>
<li>subnet router</li>
<li>control services public interfaces</li>
<li>object storage cluster internal comm</li>
<li>compute and storage commu</li>
<li>out-of-band remote mgt</li>
<li>in-band remote mgt</li>
<li>spare space for future growth</li>
</ul>
<h3 id="Network_Topology">Network Topology</h3>
<p>OS 提供了不同的NetworkManager，会对网络拓扑有不同的需求：</p>
<ul>
<li>Flat</li>
<li>FlatDHCP</li>
<li>VlanManager</li>
<li>FlatDHCP Multi-host HA</li>
</ul>
<p>(<em>TODO</em>) 是不是因为版本原因，未列出GRE Tunel</p>
<p>VLAN/Multi-NIC (<em>TODO</em>)/Mutli-host and Single-host Networking</p>
<h3 id="Services_for_Networking">Services for Networking</h3>
<p>NTP/DNS(dnsmasq)</p>
<h2 id="CH7_Example_Architecture">CH7 Example Architecture</h2>
<p>选型考虑</p>
<p>选择的各个组件及其原因</p>
<ul>
<li>…</li>
<li>RabbitMQ: only option which supports features such as Compute Cells ? (<em>TODO</em>) =&gt; trunk上的op文档也是这么说</li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-27T14:52:22.000Z"><a href="/2014/03/2014-03-12-vsphere-ha-deep-dive-notes/">Mar 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/2014-03-12-vsphere-ha-deep-dive-notes/"></a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="-5b-Notes-5d-_VMWare_vSphere_5-1_Clustering_Deepdive_-_HA">[Notes] VMWare vSphere 5.1 Clustering Deepdive - HA</h1>
<h2 id="HA-4ecb-7ecd-">HA介绍</h2>
<h3 id="HA">HA</h3>
<p>云计算或虚拟化环境中的高可用性（High Available/HA)的目标是针对运行在VM中应用的。典型的场景是将多个Host组成一个HA集群，当其中的VM所在的主机故障的时候，可以自动的在集群中其它Host上将VM重新拉起。</p>
<p>更进一步，除了VM所在主机故障的情形外，还可以在VM中Guest OS乃至特定应用的状态发生故障时，触发HA。当然，对于GuestOS相关的监控则会依赖于VMWare Tools。</p>
<h3 id="-548c-MSCS-5bf9-6bd4-">和MSCS对比</h3>
<p>MSCS集群方案的目标之一也是提供应用的高可用性，虚拟化场景下的HA和MSCS的区别主要有：</p>
<ul>
<li>MSCS只保证在一个节点故障的时候，将其上没得APP迁移到其它节点上，至于服务在此之后是否正常运转，则要求运行在其上面的APP有特定设计</li>
<li>相比HA,MSCS使用和配置起来更为复杂</li>
</ul>
<h3 id="5-x-7684-HA-65b0-7279-70b9-">5.x的HA新特点</h3>
<p><strong>5.0版本</strong></p>
<ul>
<li>新的HA Agent：FDM</li>
<li>不再依赖DNS</li>
<li>支持管理网分区的情况</li>
<li>引入Primary 和 Slave Node的概念</li>
<li>强化隔离验证：避免管理网完全故障时的误报</li>
<li>引入基于存储的datastore心跳</li>
<li>强化Admission Control Polices</li>
</ul>
<p><strong>5.1版本</strong></p>
<ul>
<li>进一步强化和增强Admission Control Policies</li>
<li>强化对PDL(Permanent Device Loss)的处理</li>
<li>支持Guest OS休眠模式</li>
<li>在VMWare Tools SDK中引入APP监控SDK</li>
<li>FDM VIB自动加入Auto-Deploy image profile</li>
<li>支持通过配置延迟触发isolation response（具体含义在后文中解释）</li>
</ul>
<h2 id="HA-67b6-6784-">HA架构</h2>
<p>[[TODO HA涉及的组件和架构图]]</p>
<p>其主要的组件包括：</p>
<ul>
<li>FDM</li>
<li>HOSTD</li>
<li>vCenter</li>
</ul>
<h3 id="FDM">FDM</h3>
<p><strong>职责</strong></p>
<ol>
<li>向集群中其它host传播信息：host resource info；vm state；HA properties</li>
<li>处理心跳机制</li>
<li>vm placement</li>
<li>vm restarts</li>
<li>logging （单独的fdm.log日志）</li>
</ol>
<p><strong>自身的可靠性</strong></p>
<ol>
<li>watchdog</li>
<li>resilient to network interruptions and “all paths down” (APD) conditions</li>
<li>在网络故障时，各主机间的通信可自动使用其它的通信路径（支持冗余路径）</li>
</ol>
<h3 id="HOSTD_Agent">HOSTD Agent</h3>
<p><strong>职责</strong></p>
<p>many of the tasks we take for granted like powering on vm</p>
<p><strong>和FDM的关系</strong></p>
<ul>
<li>FDM直接和HOSTD和vCenter通信，使得HA可更快的响应power-on request，降低VM的启动时间</li>
<li>FDM依赖HOSTD获取host上注册的vm信息，管理VM也是通过HOSTD APIs</li>
<li>如果HOSTD失效，则FDM也会失效</li>
</ul>
<h3 id="vCenter">vCenter</h3>
<p><strong>职责</strong></p>
<ol>
<li>部署和配置HA Agents（支持并发部署）</li>
<li>通知集群配置变更到选举出的master，变更包括调整高级设置、添加新host等等</li>
<li>启用和停止虚拟机的保护 (场景：比如vm开关机、master所在ESX断连等场景）</li>
</ol>
<p><strong>和HA的关系</strong></p>
<p>需要注意的是，在HA处理故障时，并不需要vCenter的参与，但HA依赖vCenter来配置或监控集群。在vCenter故障时，HA Cluster的配置变更不可用。</p>
<p>HA依赖vCenter提供的信息包括：</p>
<ol>
<li>保护的vm列表</li>
<li>集群配置</li>
<li>vm-to-host兼容性信息</li>
<li>host membership</li>
</ol>
<p>vCenter及提供其依赖的服务的VM，需要在HA时具有高优先级来进行恢复</p>
<h2 id="-57fa-672c-6982-5ff5-">基本概念</h2>
<p>HA涉及到的基本概念包括：</p>
<ul>
<li>Master/Slave agents<ul>
<li>除了网络分区的场景外，cluster中只有一个master HA agent</li>
<li>master负责监控其负责的VM的健康状态，并且在其失败时进行重启</li>
<li>slave负责转发信息到master，以及在master的指导下重启VM</li>
</ul>
</li>
<li>Heartbeating</li>
<li>Isolated vs Network partitioned</li>
<li>VM Protection</li>
</ul>
<h3 id="Master_Agent">Master Agent</h3>
<p><strong>职责</strong></p>
<ul>
<li>跟踪监控自己负责的VM，并在需要HA的条件下触发相应的行为。</li>
<li>负责监控slave状态且向vCenter上报slave host的状态，如果slave故障了，Master会决定哪些VM需要重启，且决定其placement</li>
</ul>
<p><strong>Master的确定</strong></p>
<p>Master是由Cluster中的HA Agents来进行选举出来的，可触发选举的场景包括如下几种：</p>
<ul>
<li>初始配置Cluster</li>
<li>当之前的Master所在主机<ul>
<li>故障</li>
<li>网络分区或隔离</li>
<li>从vCenter断开</li>
<li>进入维护或standby模式</li>
<li>HA被重配置</li>
</ul>
</li>
</ul>
<p>满足如下条件的HA Agent会被选举为Master：</p>
<ul>
<li>连接datastore数目最多</li>
<li>具有最大的Managed Object Id</li>
</ul>
<p>选举通过UDP协议，大概时间为15s。选举过程中不能处理故障，这些故障需要在选举完毕后，由Master进行处理。</p>
<p>在选举出Master后，其余Agent就是Slave。各Slave会通过管理平面，和Master建立安全、加密的TCP连接(SSL)，在有Master的情况下，Slaves相互之间不会通信，除非重新进行选举。</p>
<p><strong>Master的工作原理</strong></p>
<p>Master will claim responsibility for a vm by taking “ownership” of the datastore on which the virtual machine’s configuration file is stored。 </p>
<p>所谓获取”ownership”，是指在相应datastore中如下位置建立protectedlist文件，并进行lock:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="comment">/</span>&lt;<span class="comment">root</span> <span class="comment">of</span> <span class="comment">datastore</span>&gt;<span class="comment">/</span><span class="string">.</span><span class="comment">vSphere</span><span class="literal">-</span><span class="comment">HA/</span>&lt;<span class="comment">cluster</span><span class="literal">-</span><span class="comment">specific</span><span class="literal">-</span><span class="comment">dir</span>&gt;<span class="comment">/protectedlist</span>
</pre></td></tr></table></figure>

<p>其中”protectedlist”文件的内容包括：</p>
<ul>
<li>被HA保护的VM列表</li>
<li>VM的 cpu reservation and memory overhead</li>
</ul>
<p>Master会在集群中VM所使用的各个datastores中放置此文件</p>
<p>另外，Master会试图获取满足如下任一条件的datastore的ownership：</p>
<ul>
<li>自己可以直接访问到的</li>
<li>可以通过slave中转请求访问到的</li>
<li>自己后续发现的</li>
<li>对于之前没有获取成功的datastore会周期性进行重试</li>
</ul>
<p><strong>Master异常</strong></p>
<p>如上节所述，Master会lock datastore，如果Master故障或者隔离的情况下，如何处理呢？ 可分为如下几种异常场景进行分析：</p>
<ul>
<li>master fail：lock会expire，新master会relock</li>
<li>master isolation: master会release lock，至于如何判断自己处于隔离状态，可参考[[TODO]]）</li>
<li>fail while isolation：restart of vms will be delayed until a new master has been elected</li>
</ul>
<p>而Slave通过到Master点对点的心跳判断Master是否异常来决定是否重新选举新的Master。</p>
<h3 id="Slaves">Slaves</h3>
<p><strong>职责</strong></p>
<ul>
<li>监控host上运行的VM状态，并通知master状态变化</li>
<li>监控到master的心跳</li>
<li>到master不可达后，发起并参与选举；</li>
<li>发送心跳到master</li>
</ul>
<h3 id="Files_for_both_slave_and_master">Files for both slave and master</h3>
<p>Master和Slave不仅使用文件来存储状态数据，也会使用文件（Remote File）作为一种通信机制。</p>
<p><strong>Remote Files</strong></p>
<p>放置在共享存储上的文件主要是poweron文件，其有俩作用：</p>
<ul>
<li>tracking vm power-on state</li>
<li>Slaves会通过此文件来标记其是否处于和管理网隔离的状态，Master会通过此文件获知此信息</li>
</ul>
<p><strong>Local Files</strong></p>
<p>Master/Slave均会放置一些文件在本地存储上，主要包括：</p>
<ul>
<li>clusterconfig</li>
<li>vmmetadata/compatlist</li>
<li>fdm.cfg(logging cfg)</li>
<li>hostlist(IP,hostname,mac) </li>
</ul>
<h3 id="Heartbeating">Heartbeating</h3>
<p>在5.x的HA中有两种心跳：</p>
<ul>
<li>网络心跳</li>
<li>存储心跳</li>
</ul>
<p><strong>网络心跳</strong></p>
<p>网络心跳均为点到点的,非广播或组播，心跳周期为1秒，会在如下部件间存在：</p>
<ul>
<li>slave到master</li>
<li>master到所有的slaves</li>
</ul>
<p><strong>存储心跳</strong></p>
<p>存储心跳，也叫Datastore Heartbeating，仅会在master和Slave之间管理网不通时，才会用于进一步判断主机是否已经故障或者仅仅是隔离/分区。</p>
<p>默认HA会选择两个用作存储心跳的datastore，且会优先选择集群中能被尽可能多主机访问的datastore，另外相对NFS datastore，会优先选择VMFS datastore。</p>
<p>VMFS的datastore，存储心跳是通过VNFS的heartbeat region机制来实现的。只要一个Host打开了VMFS datastore上的文件，就会自动在heartbeat region中有心跳。HA会在VMFS datastore上创建特定的per-host file来由各个Host打开。</p>
<p>对于NFS的datastore，由个主机负责每隔5s中更新本主机对应的心跳文件。</p>
<p>如果之前用于hb的datastore不可用或者被移除了，HA会检测到并重新选择新的datastore用于心跳</p>
<p>Isolation: through “poweron” file</p>
<p>host failed (no datastore hb) =&gt; restart the failed host’s vms<br>host isolated/np =&gt; only take action when it is appropriate to. (只有vm被down or power down/shutdown by a triggered isolation resp) (后续章节内容，TODO）</p>
<h3 id="Isolated_versus_Partitioned">Isolated versus Partitioned</h3>
<p>[[TODO: 配图]]<br>[[TODO: isolation address]]</p>
<p>需要注意的是，从上层Admisitrator和从HA的FDM的视角来看，可能会看到不同的故障场景。</p>
<p>Administrator’s perspective:<br>partitioned: 俩主机可以操作但是通过管理网络和对方不通<br>Isolated： 主机不能在管理网络上observe任何HA管理traffic，而且不能ping通配置的isolation address</p>
<p>FDM perspective当FDM无法和master通信，就会选举新的master如果网络分区了，a master election will occur so that a host failure or network isolation with this partition will result in appropriate action on the impacted vms每一个网络分区中，均会有自己的master，分区恢复后，任何一个master都可以作为新的master一个master可以负责另一个网络分区的VM，VM状态的监控通过datastore communication mechanism<br>在HA架构中，一个主机是否被分区了， is determinated by the master reporting the condition。比如分区发生后，各自分区的master均会上报vCenter当前哪些主机被分区了，vCenter会进行展示。master仅根据管理网不通可以确定host是partition或isolate，但不能区分。一个host只有它自己通过datastore通知master自己隔离了，master才可以上报此主机是isolated （问题：host和datastore断连了咋办？）<br>俩视图可能会有不一致的情况，比如host到存储也断了，管理网和master也不通了，则从HA看，此host是故障了，但从Administrato看此host是隔离了。</p>
<p>HA基于host的state来触发相应的action。<br>[ ]Host Failed： will initiate restart of vms<br>[ ]Host Isolated: might initiate restart<br>A virtual machine will only be shutdown or powered off when the isolated host knows there is a master out there that has taken ownership for the vm or when the isolated host loses access to the home datastore of the vm<br>[ ]在主机对于其上面VM所在的datastore无Access能力时（APD)，HA会触发isolation response来保证原VM被关机并安全重启，避免脑裂 （问题：HA咋触发？）（问题：Isolation Response）</p>
<h3 id="VM_Protection">VM Protection</h3>
<p>虚拟机状态变化后，vCenter会通知master来启用或禁用此VM的HA保护。 启用或禁用保护的操作，master需要保证将虚拟机状态更新到disk上后才可以返回成功</p>
<h2 id="CH4_Restarting_VMs">CH4 Restarting VMs</h2>
<p>HA响应VM故障的场景：<br>Failed Host<br>Isolated Host<br>Failed guest os</p>
<h3 id="Restart_Priority_and_Order">Restart Priority and Order</h3>
<p>Agent VM<br>FT secondary vm<br>priority of high<br>priority of medium<br>priority of low</p>
<h3 id="Restart_Retries">Restart Retries</h3>
<p>可配置 （0 2 6 14 30m -&gt; 5次重试）</p>
<h3 id="-573a-666f-ff1a-Failed_Host">场景：Failed Host</h3>
<p>Failed Slave<br>T0-fail；T3s-master 监控datastore hb持续15s；T10s-host被宣布为不可达，master开始ping host的管理网，持续5s；T15s-如果host没有配置datastore hb，则host被宣布为dead；T18s-如果host配置了datastore hb，主机被宣布为dead</p>
<p>处理： (5.1) master会从protectedlist中，也可以向vCenter获取vm列表，进行重启。 后者是避免在网络分区情况下，其中一个master那分区中没有足够资源拉起vm，5.1允许多个master同时试图重启同一台VM<br>Failed master<br>T0-fail; T10s-Master election process initiated; T25s-新选举出的master读取protectedlist; T35s-新master对于protectedlist中未运行的vm发起重启</p>
<p>Isolation Resp and Detection</p>
<p>Isolation Resp: HA在主机lost its conn with the network and the remaining nodes in the cluster 后所会采取的行为。<br>Power Off 、 Leave Power on、Shut down<br>如果选择的是关机，但是否会触发，还依赖于host判断是否有own vm所在datastore的master可以restart此vm<br>如果触发了resp，会首先将vm重poweron文件中移除，并在poweredoff文件夹下建立相应的vm file<br>选择关机的一种场景：vm可以访问vm网络但是不能访问它的存储，如果它维持开机，则会出现俩相同IP的vm（问题：为什么？）</p>
<p>Isolation DetectionIsolation Slave：<br>5.1：<br>期间有任何状态变化，均不会再触发isolation response。</p>
<p>如果Isolation Resp被触发了：</p>
<p>Isolation Master：</p>
<p>Restarting VM<br>Placement； DRS Relation</p>
<h3 id="Split-Brain">Split-Brain</h3>
<h3 id="Permanent_Device_Loss">Permanent Device Loss</h3>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-03-27T14:52:22.000Z"><a href="/2014/03/2014-03-11-novaclient-boot-process/">Mar 27 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/03/2014-03-11-novaclient-boot-process/"></a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="novaclient-2019-s_boot_process">novaclient’s boot process</h1>
<h2 id="novaclient">novaclient</h2>
<p>novaclient是用于在CLI模式下与NOVA进行交互的工具， 其将NOVA的功能封装为多个命令，执行命令时的过程均为构造相应的REST请求和NOVA标准和扩展的REST API进行交互。</p>
<p>novaclient的可执行文件为nova, 可通过nova help命令来查看其支持的所有命令。每个命令执行时可通过添加—debug选项来将其执行过程中和NOVA及相关Project的REST API进行交互的过程均输出出来，便于分析。</p>
<p>nova的boot命令主要用于创建一个新的虚拟机(Instance), 其支持的命令行参数很多，这里以几个常见的命令行参数来调用boot，并就其执行流程进行分析。</p>
<h2 id="-73af-5883-4fe1-606f-">环境信息</h2>
<p>为了使得novaclient可以获得keystone的授权，一般会在环境中配置如下的RC文件，其中会包含admin tenant的相应信息。</p>
<p>本例的RC文件内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="shebang">#!/bin/bash
</span>
<span class="keyword">export</span> OS_AUTH_URL=http://{CONTROLLER_IP}:<span class="number">5000</span>/v2.<span class="number">0</span> <span class="comment">#这里的controller_ip是controller节点的IP</span>

<span class="comment"># With the addition of Keystone we have standardized on the term **tenant**</span>
<span class="comment"># as the entity that owns the resources.</span>
<span class="keyword">export</span> OS_TENANT_ID=<span class="number">507667477</span>fd840e1a81c1ca7f6f54f69
<span class="keyword">export</span> OS_TENANT_NAME=<span class="string">"admin"</span>

<span class="comment"># In addition to the owning entity (tenant), openstack stores the entity</span>
<span class="comment"># performing the action as the **user**.</span>
<span class="keyword">export</span> OS_USERNAME=<span class="string">"admin"</span>

<span class="comment"># With Keystone you pass the keystone password.</span>
<span class="keyword">export</span> OS_PASSWORD=<span class="string">"admin"</span>
</pre></td></tr></table></figure>

<h2 id="-547d-4ee4-548c-671f-671b-7ed3-679c-">命令和期望结果</h2>
<p>针对如下命令的执行过程进行分析：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="comment">nova</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">debug</span> <span class="comment">boot</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">flavor</span> <span class="comment">m1</span><span class="string">.</span><span class="comment">tiny</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">image</span> <span class="comment">cirros</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">swap</span> <span class="comment">100</span> <span class="comment">test2</span>
</pre></td></tr></table></figure>

<p>其中m1.tiny flavor的swap大小配置为0，通过命令行指定其swap大小为100M，超过了flavor的配置，故此命令期望的结果是NOVA会返回错误。</p>
<h2 id="-6267-884c-6d41-7a0b-5206-6790-">执行流程分析</h2>
<p>nova可执行文件的执行入口是novaclient.shell:main。其主要执行步骤如下：</p>
<ul>
<li>首先进行Authorization</li>
<li>根据子命令名称(boot)，调用相应的方法<ul>
<li>构造启动参数</li>
<li>确定ResourceUrl</li>
<li>发送POST请求</li>
</ul>
</li>
</ul>
<h3 id="Authorization">Authorization</h3>
<p>首先会进行authorization。从debug的输出也可以看到，在authorization时，会首先根据RC文件中的配置信息，调用novaclient.v1_1.client:authenticate,并最终向keystone发出如上请求获取token。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="comment">REQ:</span> <span class="comment">curl</span> <span class="literal">-</span><span class="comment">i</span> <span class="comment">http://{CONTROLLER_IP}/v2</span><span class="string">.</span><span class="comment">0/tokens</span> <span class="literal">-</span><span class="comment">X</span> <span class="comment">POST</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Content</span><span class="literal">-</span><span class="comment">Type:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Accept:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"User</span><span class="literal">-</span><span class="comment">Agent:</span> <span class="comment">python</span><span class="literal">-</span><span class="comment">novaclient"</span> <span class="literal">-</span><span class="comment">d</span> <span class="comment">'{"auth":</span> <span class="comment">{"passwordCredentials":</span> <span class="comment">{"username":</span> <span class="comment">"admin"</span><span class="string">,</span> <span class="comment">"password":</span> <span class="comment">"admin"}</span><span class="string">,</span> <span class="comment">"tenantId":</span> <span class="comment">"507667477fd840e1a81c1ca7f6f54f69"}}'</span>
</pre></td></tr></table></figure>

<p>最终的返回结果如下，返回结果中会包含token、tenant列表以及所有的endpoints等等(有省略）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre>DEBUG (connectionpool:<span class="number">295</span>) <span class="string">"POST /v2.0/tokens HTTP/1.1"</span> <span class="number">200</span> <span class="number">3302</span>
RESP: [<span class="number">200</span>] {<span class="string">'date'</span>: <span class="string">'Tue, 11 Mar 2014 07:17:54 GMT'</span>, <span class="string">'content-type'</span>: <span class="string">'application/json'</span>, <span class="string">'content-length'</span>: <span class="string">'3302'</span>, <span class="string">''</span>}
RESP BODY: {<span class="string">"access"</span>: {<span class="string">"token"</span>: {<span class="keyword">...</span>}}, <span class="string">"serviceCatalog"</span>: [<span class="keyword">...</span>], <span class="string">"user"</span>: {<span class="keyword">...</span>}, <span class="string">"metadata"</span>: {<span class="keyword">...</span>}}}
</pre></td></tr></table></figure>

<h3 id="-542f-52a8-Instance">启动Instance</h3>
<p>boot命令对应的方法为novaclient.v1_1.shell:do_boot，在此方法中会首先调用novaclient.v1_1.shell:_boot方法，来构造启动参数。</p>
<h4 id="-6784-9020-542f-52a8-53c2-6570-28-_boot_-65b9-6cd5-29-">构造启动参数(_boot 方法)</h4>
<p>此方法负责初始化所有相关的启动参数，所支持的启动参数及其含义如下：</p>
<ul>
<li>name: instance name</li>
<li>image: Image to boot with</li>
<li>flavor: Flavor to boot onto</li>
<li>meta: dict of arbitrary key/value metadata to store for this instance</li>
<li>files: dict of files to overwrite on the instance upon boot. key: file name, value: file content</li>
<li>reservation_id: a UUID for the set of servers being requested</li>
<li>min_count</li>
<li>max_count</li>
<li>security_groups</li>
<li>userdata: user data to pass to be exposed by the metadata server. file type object / string</li>
<li>key_name: name of previously created keypair to inject into the instance</li>
<li>availability_zone</li>
<li>block_device_mapping</li>
<li>block_device_mapping_v2</li>
<li>nics: nics to be added to this instance</li>
<li>scheduler_hints: arbitrary key-value pairs specified by the client to help boot an instance</li>
<li>config_drive</li>
<li>disk_config: control how the disk is partitioned when the server is created. AUTO / MANUAL</li>
<li>others</li>
</ul>
<p>对于本例执行的命令行，其涉及到的处理逻辑如下所述。</p>
<p><strong> 验证并获取Image和Flavor信息 </strong></p>
<p>首先根据参数验证给定的image和flavor是否合法，并获取image和flavor的详细信息。</p>
<p>对于Image的验证，是由novaclient.v1_1.images:ImageManager来负责的。在boot命令中—image可以给定image的uuid或名称。</p>
<p>对于给定uuid的情况，ImageManager:get会被调用，根据上一步骤keystone返回的glance的endpoint来构造类似”/images/{image_uuid}”的URL来访问glance验证此Image是否存在并获取Image的详细信息。</p>
<p>对于给定名称的情况，ImageManager.list会首先被调用来通过访问”/images”来获取image列表，然后从结果中确定给定Image的uuid，然后再通过ImageManager:get方法来获取Image的信息。 </p>
<p>对于flavor参数的验证和信息获取与之类似。</p>
<p>下面是获取给定Image信息时，涉及的API交互信息(有省略）：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre><span class="comment">REQ:</span> <span class="comment">curl</span> <span class="literal">-</span><span class="comment">i</span> <span class="comment">http://{CONTROLLER_IP}:8774/v2/507667477fd840e1a81c1ca7f6f54f69/images</span> <span class="literal">-</span><span class="comment">X</span> <span class="comment">GET</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Project</span><span class="literal">-</span><span class="comment">Id:</span> <span class="comment">admin"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"User</span><span class="literal">-</span><span class="comment">Agent:</span> <span class="comment">python</span><span class="literal">-</span><span class="comment">novaclient"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Accept:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Token:</span> <span class="comment">1c8848a651a24e35ad74cea8eeba1cd3"</span>

<span class="comment">DEBUG</span> <span class="comment">(connectionpool:295)</span> <span class="comment">"GET</span> <span class="comment">/v2/507667477fd840e1a81c1ca7f6f54f69/images</span> <span class="comment">HTTP/1</span><span class="string">.</span><span class="comment">1"</span> <span class="comment">200</span> <span class="comment">3724</span>
<span class="comment">RESP:</span> <span class="title">[</span><span class="comment">200</span><span class="title">]</span> <span class="comment">{'date':</span> <span class="comment">'Tue</span><span class="string">,</span> <span class="comment">11</span> <span class="comment">Mar</span> <span class="comment">2014</span> <span class="comment">09:28:55</span> <span class="comment">GMT'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">length':</span> <span class="comment">'3724'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">type':</span> <span class="comment">'application/json'</span><span class="string">,</span> <span class="comment">'x</span><span class="literal">-</span><span class="comment">compute</span><span class="literal">-</span><span class="comment">request</span><span class="literal">-</span><span class="comment">id':</span> <span class="comment">'req</span><span class="literal">-</span><span class="comment">fb8f0a9e</span><span class="literal">-</span><span class="comment">0caf</span><span class="literal">-</span><span class="comment">4e34</span><span class="literal">-</span><span class="comment">bbe6</span><span class="literal">-</span><span class="comment">abb0513ae2e2'}</span>
<span class="comment">RESP</span> <span class="comment">BODY:</span> <span class="comment">{"images":</span> <span class="title">[</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="string">,</span> <span class="comment">{"id":</span> <span class="comment">"ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"links":</span> <span class="title">[</span><span class="comment">{"href":</span> <span class="comment">"http://186</span><span class="string">.</span><span class="comment">100</span><span class="string">.</span><span class="comment">8</span><span class="string">.</span><span class="comment">144:8774/v2/507667477fd840e1a81c1ca7f6f54f69/images/ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"rel":</span> <span class="comment">"self"}</span><span class="string">,</span> <span class="comment">{"href":</span> <span class="comment">"http://186</span><span class="string">.</span><span class="comment">100</span><span class="string">.</span><span class="comment">8</span><span class="string">.</span><span class="comment">144:8774/507667477fd840e1a81c1ca7f6f54f69/images/ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"rel":</span> <span class="comment">"bookmark"}</span><span class="string">,</span> <span class="comment">{"href":</span> <span class="comment">"http://186</span><span class="string">.</span><span class="comment">100</span><span class="string">.</span><span class="comment">8</span><span class="string">.</span><span class="comment">144:9292/507667477fd840e1a81c1ca7f6f54f69/images/ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"type":</span> <span class="comment">"application/vnd</span><span class="string">.</span><span class="comment">openstack</span><span class="string">.</span><span class="comment">image"</span><span class="string">,</span> <span class="comment">"rel":</span> <span class="comment">"alternate"}</span><span class="title">]</span><span class="string">,</span> <span class="comment">"name":</span> <span class="comment">"cirros"}</span><span class="title">]</span><span class="comment">}</span>


<span class="comment">REQ:</span> <span class="comment">curl</span> <span class="literal">-</span><span class="comment">i</span> <span class="comment">http://{CONTROLLER_IP}:8774/v2/507667477fd840e1a81c1ca7f6f54f69/images/ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96</span> <span class="literal">-</span><span class="comment">X</span> <span class="comment">GET</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Project</span><span class="literal">-</span><span class="comment">Id:</span> <span class="comment">admin"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"User</span><span class="literal">-</span><span class="comment">Agent:</span> <span class="comment">python</span><span class="literal">-</span><span class="comment">novaclient"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Accept:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Token:</span> <span class="comment">1c8848a651a24e35ad74cea8eeba1cd3"</span>

<span class="comment">DEBUG</span> <span class="comment">(connectionpool:295)</span> <span class="comment">"GET</span> <span class="comment">/v2/507667477fd840e1a81c1ca7f6f54f69/images/ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96</span> <span class="comment">HTTP/1</span><span class="string">.</span><span class="comment">1"</span> <span class="comment">200</span> <span class="comment">720</span>
<span class="comment">RESP:</span> <span class="title">[</span><span class="comment">200</span><span class="title">]</span> <span class="comment">{'date':</span> <span class="comment">'Tue</span><span class="string">,</span> <span class="comment">11</span> <span class="comment">Mar</span> <span class="comment">2014</span> <span class="comment">09:28:55</span> <span class="comment">GMT'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">length':</span> <span class="comment">'720'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">type':</span> <span class="comment">'application/json'</span><span class="string">,</span> <span class="comment">'x</span><span class="literal">-</span><span class="comment">compute</span><span class="literal">-</span><span class="comment">request</span><span class="literal">-</span><span class="comment">id':</span> <span class="comment">'req</span><span class="literal">-</span><span class="comment">c636e7d0</span><span class="literal">-</span><span class="comment">b74c</span><span class="literal">-</span><span class="comment">42d6</span><span class="literal">-</span><span class="comment">8635</span><span class="literal">-</span><span class="comment">e24076f9aeff'}</span>
<span class="comment">RESP</span> <span class="comment">BODY:</span> <span class="comment">{"image":</span> <span class="comment">{"status":</span> <span class="comment">"ACTIVE"</span><span class="string">,</span> <span class="comment">"updated":</span> <span class="comment">"2014</span><span class="literal">-</span><span class="comment">02</span><span class="literal">-</span><span class="comment">26T08:18:39Z"</span><span class="string">,</span> <span class="comment">"links":</span> <span class="title">[</span><span class="string">.</span><span class="string">.</span><span class="string">.</span><span class="title">]</span><span class="string">,</span> <span class="comment">"id":</span> <span class="comment">"ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"OS</span><span class="literal">-</span><span class="comment">EXT</span><span class="literal">-</span><span class="comment">IMG</span><span class="literal">-</span><span class="comment">SIZE:size":</span> <span class="comment">13147648</span><span class="string">,</span> <span class="comment">"name":</span> <span class="comment">"cirros"</span><span class="string">,</span> <span class="comment">"created":</span> <span class="comment">"2014</span><span class="literal">-</span><span class="comment">02</span><span class="literal">-</span><span class="comment">26T08:03:29Z"</span><span class="string">,</span> <span class="comment">"minDisk":</span> <span class="comment">1</span><span class="string">,</span> <span class="comment">"progress":</span> <span class="comment">100</span><span class="string">,</span> <span class="comment">"minRam":</span> <span class="comment">512</span><span class="string">,</span> <span class="comment">"metadata":</span> <span class="comment">{}}}</span>
</pre></td></tr></table></figure>

<p><strong> swap的处理 </strong></p>
<p>然后会处理block_device_mapping配置，本例中不涉及—block-device-mapping命令行参数，无影响。 </p>
<p>下面是处理bdm的代码，做参考：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre>    block_device_mapping = <span class="cell">{}</span>
    <span class="keyword">for</span> bdm in <span class="transposed_variable">args.</span>block_device_mapping:
        device_name, mapping = <span class="transposed_variable">bdm.</span>split(<span class="string">'='</span>, <span class="number">1</span>)
        block_device_mapping<span class="matrix">[device_name]</span> = mapping
</pre></td></tr></table></figure>

<p>本例中命令行添加了-swap参数，在后面调用的_parse_block_device_mapping_v2中会在启动参数中生成相应的block_device_mapping_v2信息。</p>
<p>打开_parse_block_device_mapping_v2方法，可以看到，其处理的命令行参数包括：</p>
<ul>
<li>—boot-volume</li>
<li>—snapshot</li>
<li>—block-device</li>
<li>—ephemeral</li>
<li>—swap</li>
</ul>
<p>其中对于本例涉及的—swap，其处理逻辑如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>    <span class="keyword">if</span> args.swap:
        bdm_dict = {<span class="comment">'source_type': 'blank', 'destination_type': 'local',</span>
                    <span class="comment">'boot_index': -1, 'delete_on_termination': True,</span>
                    <span class="comment">'guest_format': 'swap', 'volume_size': args.swap}</span>
        bdm.append(bdm_dict)
</pre></td></tr></table></figure>

<p>即会生成相应的block_device_mapping_v2信息，并附加到启动参数中。</p>
<h4 id="-8bbe-7f6e-ResourceUrl">设置ResourceUrl</h4>
<p>do_boot方法,接着会调用novaclient.v1_1.servers.ServerManager:create方法，其接收的参数就是前文提到的各个启动参数。</p>
<p>由此方法的代码可知，如果启动参数包含block_device_mapping(_v2),则设置resource_url为/os-volumes_boot, 否则设置为/servers。并最终会用此resource_url为参数调用novaclient.v1_1.servers.ServerManager:_boot进行后续操作。</p>
<p>如前所述，在本例中，block_device_mapping_v2已经被设置，故resource_url为/os-volumes_boot</p>
<h3 id="-6784-9020-REST-8bf7-6c42-">构造REST请求</h3>
<p>在ServerManager:_boot方法中，其会构造相应的body，不同启动参数和body的内容对应关系如下：</p>
<ul>
<li>name: server.name</li>
<li>image: getid =&gt; server.imageRef</li>
<li>flavor: getid =&gt; server.flavorRef</li>
<li>userdata: (read)+base64encode =&gt; server.user_data</li>
<li>meta: server.metadata</li>
<li>reservation_id: server.reservation_id</li>
<li>key_name: server.key_name</li>
<li>scheduler_hints: os:scheduler_hints</li>
<li>config_drive: server.config_drive</li>
<li>admin_pass: server.adminPass</li>
<li>min_count: server.min_count</li>
<li>max_count: server.max_count</li>
<li>security_group: [{‘name’: sg} … ] =&gt; server.security_group</li>
<li>files: [{“path”:filepath, “contents”: base64encode(data)}, …] =&gt; server.personality</li>
<li>availability_zone: server.availability_zone</li>
<li>block_device_mapping: server.block_device_mapping</li>
<li>block_device_mapping_v2: server.block_device_mapping_v2</li>
<li>nics: [{‘uuid’:get(‘net-id’), ‘fixed_ip’:get(‘v4-fixed-ip’),’port’:get(‘port-id’)},…]=&gt; server.networks</li>
<li>disk_config: server.OS-DCF:diskConfig</li>
</ul>
<p>接着调用base.Manager:_create方法来发送POST请求并返回结果，对应如下debug信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="comment">REQ:</span> <span class="comment">curl</span> <span class="literal">-</span><span class="comment">i</span> <span class="comment">http://{CONTROLLER_IP}:8774/v2/507667477fd840e1a81c1ca7f6f54f69/os</span><span class="literal">-</span><span class="comment">volumes_boot</span> <span class="literal">-</span><span class="comment">X</span> <span class="comment">POST</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Project</span><span class="literal">-</span><span class="comment">Id:</span> <span class="comment">admin"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"User</span><span class="literal">-</span><span class="comment">Agent:</span> <span class="comment">python</span><span class="literal">-</span><span class="comment">novaclient"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Content</span><span class="literal">-</span><span class="comment">Type:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"Accept:</span> <span class="comment">application/json"</span> <span class="literal">-</span><span class="comment">H</span> <span class="comment">"X</span><span class="literal">-</span><span class="comment">Auth</span><span class="literal">-</span><span class="comment">Token:</span> <span class="comment">7e1e6458f641473cb048c685e6795411"</span> <span class="literal">-</span><span class="comment">d</span> <span class="comment">'{"server":</span> <span class="comment">{"name":</span> <span class="comment">"test2"</span><span class="string">,</span> <span class="comment">"imageRef":</span> <span class="comment">"ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"block_device_mapping_v2":</span> <span class="title">[</span><span class="comment">{"source_type":</span> <span class="comment">"image"</span><span class="string">,</span> <span class="comment">"delete_on_termination":</span> <span class="comment">true</span><span class="string">,</span> <span class="comment">"boot_index":</span> <span class="comment">0</span><span class="string">,</span> <span class="comment">"uuid":</span> <span class="comment">"ad559bb4</span><span class="literal">-</span><span class="comment">31d5</span><span class="literal">-</span><span class="comment">469f</span><span class="literal">-</span><span class="comment">93b7</span><span class="literal">-</span><span class="comment">0a67546c4a96"</span><span class="string">,</span> <span class="comment">"destination_type":</span> <span class="comment">"local"}</span><span class="string">,</span> <span class="comment">{"guest_format":</span> <span class="comment">"swap"</span><span class="string">,</span> <span class="comment">"boot_index":</span> <span class="literal">-</span><span class="comment">1</span><span class="string">,</span> <span class="comment">"volume_size":</span> <span class="comment">"100"</span><span class="string">,</span> <span class="comment">"source_type":</span> <span class="comment">"blank"</span><span class="string">,</span> <span class="comment">"destination_type":</span> <span class="comment">"local"</span><span class="string">,</span> <span class="comment">"delete_on_termination":</span> <span class="comment">true}</span><span class="title">]</span><span class="string">,</span> <span class="comment">"flavorRef":</span> <span class="comment">"1"</span><span class="string">,</span> <span class="comment">"max_count":</span> <span class="comment">1</span><span class="string">,</span> <span class="comment">"min_count":</span> <span class="comment">1}}'</span>

<span class="comment">DEBUG</span> <span class="comment">(connectionpool:295)</span> <span class="comment">"POST</span> <span class="comment">/v2/507667477fd840e1a81c1ca7f6f54f69/os</span><span class="literal">-</span><span class="comment">volumes_boot</span> <span class="comment">HTTP/1</span><span class="string">.</span><span class="comment">1"</span> <span class="comment">400</span> <span class="comment">101</span>
<span class="comment">RESP:</span> <span class="title">[</span><span class="comment">400</span><span class="title">]</span> <span class="comment">{'date':</span> <span class="comment">'Tue</span><span class="string">,</span> <span class="comment">11</span> <span class="comment">Mar</span> <span class="comment">2014</span> <span class="comment">13:35:35</span> <span class="comment">GMT'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">length':</span> <span class="comment">'101'</span><span class="string">,</span> <span class="comment">'content</span><span class="literal">-</span><span class="comment">type':</span> <span class="comment">'application/json;</span> <span class="comment">charset=UTF</span><span class="literal">-</span><span class="comment">8'</span><span class="string">,</span> <span class="comment">'x</span><span class="literal">-</span><span class="comment">compute</span><span class="literal">-</span><span class="comment">request</span><span class="literal">-</span><span class="comment">id':</span> <span class="comment">'req</span><span class="literal">-</span><span class="comment">9628ca64</span><span class="literal">-</span><span class="comment">dc0f</span><span class="literal">-</span><span class="comment">4ce0</span><span class="literal">-</span><span class="comment">b4b8</span><span class="literal">-</span><span class="comment">9295c15f5995'}</span>
<span class="comment">RESP</span> <span class="comment">BODY:</span> <span class="comment">{"badRequest":</span> <span class="comment">{"message":</span> <span class="comment">"Swap</span> <span class="comment">drive</span> <span class="comment">requested</span> <span class="comment">is</span> <span class="comment">larger</span> <span class="comment">than</span> <span class="comment">instance</span> <span class="comment">type</span> <span class="comment">allows</span><span class="string">.</span><span class="comment">"</span><span class="string">,</span> <span class="comment">"code":</span> <span class="comment">400}}</span>

<span class="comment">DEBUG</span> <span class="comment">(shell:740)</span> <span class="comment">Swap</span> <span class="comment">drive</span> <span class="comment">requested</span> <span class="comment">is</span> <span class="comment">larger</span> <span class="comment">than</span> <span class="comment">instance</span> <span class="comment">type</span> <span class="comment">allows</span><span class="string">.</span> <span class="comment">(HTTP</span> <span class="comment">400)</span> <span class="comment">(Request</span><span class="literal">-</span><span class="comment">ID:</span> <span class="comment">req</span><span class="literal">-</span><span class="comment">9628ca64</span><span class="literal">-</span><span class="comment">dc0f</span><span class="literal">-</span><span class="comment">4ce0</span><span class="literal">-</span><span class="comment">b4b8</span><span class="literal">-</span><span class="comment">9295c15f5995)</span>
</pre></td></tr></table></figure>

<p>如之前的期望结果，这里NOVA会返回相应的错误。</p>
<h2 id="-540e-7eed-5de5-4f5c-">后续工作</h2>
<p>对NOVA侧接收到此POST请求后，真正的内部处理逻辑进行进一步的分析。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-09T15:40:31.000Z"><a href="/2014/02/2014-02-09-nova-structure-data-workflow/">Feb 9 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/2014-02-09-nova-structure-data-workflow/">NOVA structure data workflow</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="NOVA-4ee3-7801-603b-4f53-7ed3-6784-548c-6570-636e-6d41-5411-603b-7ed3-">NOVA代码总体结构和数据流向总结</h1>
<p><strong>前提</strong></p>
<ol>
<li>对Nova的整体结构已经有所理解</li>
<li>基于stable/havana分支</li>
<li>基于Redhat的RDO库进行的环境安装，基于CentOS 6.4</li>
<li>主机名为controller</li>
</ol>
<p><strong>内容</strong></p>
<ol>
<li>Nova代码总体组织结构</li>
<li>Nova对外提供的服务中，一般的执行路径</li>
</ol>
<p><strong>目的</strong></p>
<ol>
<li>为后续新增代码时，提供所需遵循的代码层次结构提供参考</li>
</ol>
<p><strong>注意</strong></p>
<p>尚不完整，需要进一步补充和完善</p>
<h2 id="Nova-4ee3-7801-603b-4f53-7ed3-6784-">Nova代码总体结构</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="comment">├──</span> <span class="comment">etc</span>
<span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">nova</span> <span class="literal">-</span> <span class="comment">相关配置文件</span>
<span class="comment">├──</span> <span class="comment">nova</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">api</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">对外的</span> <span class="comment">REST</span> <span class="comment">API</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">ec2</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">Amazon</span> <span class="comment">EC2</span> <span class="comment">API</span> <span class="comment">bindings</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">metadata</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">metadata</span> <span class="comment">Server</span> <span class="comment">API</span> 
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">openstack</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">OpenStack</span> <span class="comment">API</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">cell</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">Cell形似部署时的</span> <span class="comment">Cell</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">cert</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">cloudpipe</span> <span class="literal">-</span> <span class="comment">VPN</span> <span class="comment">Server</span> <span class="comment">Management</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">cmd</span> <span class="literal">-</span> <span class="comment">Component的Service启动脚本</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">compute</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">Compute</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">conductor</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">Conductor</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">console</span> <span class="literal">-</span> <span class="comment">instance</span> <span class="comment">console</span> <span class="comment">library</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">consoleauth</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">ConsoleAuth</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">db</span> <span class="literal">-</span> <span class="comment">database</span> <span class="comment">abstraction</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">hacking</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">image</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">Image</span> <span class="comment">Service</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">ipv6</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">keymgr</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">locale</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">network</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">Nova</span> <span class="comment">Network</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">neutronv2</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">Neutron</span> <span class="comment">API</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">security_group</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">objects</span> <span class="literal">-</span> <span class="comment">The</span> <span class="comment">Model</span> <span class="comment">Level</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">objectstore</span> <span class="literal">-</span> <span class="comment">基于本地文件实现的S3</span><span class="literal">-</span><span class="comment">like的Storage</span> <span class="comment">Server，主要用于测试</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">openstack</span> <span class="literal">-</span> <span class="comment">ongoing</span> <span class="comment">effort</span> <span class="comment">to</span> <span class="comment">reuse</span> <span class="comment">Nova</span> <span class="comment">parts</span> <span class="comment">with</span> <span class="comment">other</span> <span class="comment">OpenStack</span> <span class="comment">parts</span><span class="string">.</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">common</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">pci</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">scheduler</span> <span class="literal">-</span> <span class="comment">Nova</span> <span class="comment">Scheduler</span> <span class="comment">Service</span> <span class="comment">Component</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">servicegroup</span> <span class="literal">-</span> <span class="comment">Service</span> <span class="comment">Group</span> <span class="comment">Support</span>
<span class="comment">│</span>   <span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">drivers</span>  <span class="literal">-</span> <span class="comment">Service</span> <span class="comment">Group</span> <span class="comment">Drivers:</span> <span class="comment">ZooKeeper，Database，Memcached</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">spice：</span> <span class="comment">Spice</span> <span class="comment">libraries</span> <span class="comment">for</span> <span class="comment">accessing</span> <span class="comment">instances</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">storage:</span> <span class="comment">Linux</span> <span class="comment">SCSI</span> <span class="comment">Related</span> <span class="comment">Misc</span> <span class="comment">Methods</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">tests</span> <span class="literal">-</span> <span class="comment">Unit</span> <span class="comment">tests</span><span class="string">.</span> <span class="comment">Sub</span> <span class="comment">directories</span> <span class="comment">should</span> <span class="comment">mirror</span> <span class="string">.</span><span class="comment">/nova</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">virt</span> <span class="literal">-</span> <span class="comment">Hypervisor</span> <span class="comment">abstractions</span>
<span class="comment">│</span>   <span class="comment">├──</span> <span class="comment">vnc</span> <span class="literal">-</span> <span class="comment">VNC</span> <span class="comment">libraries</span> <span class="comment">for</span> <span class="comment">accessing</span> <span class="comment">instances</span>
<span class="comment">│</span>   <span class="comment">└──</span> <span class="comment">volume</span> <span class="literal">-</span> <span class="comment">the</span> <span class="comment">Volume</span> <span class="comment">Service</span>
<span class="comment">├──</span> <span class="comment">plugins</span> <span class="literal">-</span> <span class="comment">hypervisor</span> <span class="comment">host</span> <span class="comment">plugins</span><span class="string">.</span> <span class="comment">Mostly</span> <span class="comment">for</span> <span class="comment">XenServer</span><span class="string">.</span>
</pre></td></tr></table></figure>

<p>就其中已经分析或了解到的部分进行下说明：</p>
<ul>
<li>Service Component：对应的就是一个个Nova服务，即nova-compute、nova-scheduler、nova-conductor，等等</li>
<li>cmd： 用于启动相应的Nova Service, 主要是利用Service.Create来封装相应的Service Component。例如cmd.api和cmd.scheduler分别是启动nova-api和nova-scheduler服务的。RDO的相应的服务启动脚本最终都是调用的这里</li>
<li>conductor： 引入的目的是为了避免compute直接对数据库的访问，并引入些跨计算节点的功能。从目前Havana代码来看，还有很多功能还是直接由compute来访问数据库的，比如关机等</li>
</ul>
<h2 id="Service_Component">Service Component</h2>
<p>每个Service Component基本都会包含由api、manager和rpcapi，api主要用于模块间的直接调用，rpcapi主要用于通过MQ进行远程的模块间调用，manager主要用于此模块的功能，具体执行时，又可能会有多个driver可选。</p>
<h2 id="Data_Workflow">Data Workflow</h2>
<p>一般来说，一个对外的计算相关特性的具体执行路径为：</p>
<ol>
<li>首先由nova.api.openstack.compute来处理REST API相关逻辑</li>
<li>调用Controller的计算服务，及nova.compute.api</li>
<li>涉及到远程调用其它Service Component的，则会调用相应Component的rpcapi，通过MQ发送消息，涉及到本地调用其它Service Component的，则会调用其的api</li>
<li>相应的Service Component的Manager会从MQ中接收到相应的消息或者被此Component的api调用，根据请求类型，使用相应的driver或者继续按3的过程和其它Component进行交互</li>
</ol>
<h2 id="-53c2-8003-8d44-6599-">参考资料</h2>
<ul>
<li><a href="http://www.sandywalsh.com/2012/04/openstack-nova-internals-pt1-overview.html" target="_blank">Nova Internals</a></li>
<li><a href="http://www.slideshare.net/lzyeval/hacking-on-openstacks-nova-source-code" target="_blank">Hacking on Openstack Nova Souce Code</a></li>
<li><a href="http://docs.openstack.org/developer/nova/devref/services.html" target="_blank">Service, Mananger 和 Driver</a></li>
</ul>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-02-09T14:55:31.000Z"><a href="/2014/02/2014-02-09-nova-v3-api-extension-framework/">Feb 9 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/02/2014-02-09-nova-v3-api-extension-framework/">NOVA V3 API Extension Framework</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="NOVA_V3_API_Extension_Framework">NOVA V3 API Extension Framework</h1>
<p><strong>背景</strong></p>
<ol>
<li>基于stable/havana分支</li>
<li>基于CentOS 6.4，以Redhat的RDO库进行的环境安装</li>
</ol>
<p><strong>内容</strong></p>
<ol>
<li>V2扩展机制存在的问题</li>
<li>Nova API V3中Plugin的实现机制和现状</li>
<li>总结</li>
</ol>
<h2 id="V2-7684-6269-5c55-673a-5236-5b58-5728-7684-95ee-9898-">V2的扩展机制存在的问题</h2>
<p>参考V3 API framework的Spec，当前V2 API存在的问题如下：</p>
<p>The development of the Nova v3 API will give us the opportunity to rework the extension framework. The current framework suffers from:</p>
<ul>
<li>extension specific code required to exist in core code for specific extensions to work<ul>
<li>eg nova/api/openstack/compute/servers.py:Controller:create where there are hard coded references to parameters specific to extensions to pass kwargs to the server create call</li>
</ul>
</li>
<li>issues around efficiency with extensions each doing their own db lookup loops<ul>
<li><a href="https://bugs.launchpad.net/nova/+bug/1160487" target="_blank">https://bugs.launchpad.net/nova/+bug/1160487</a></li>
</ul>
</li>
<li>Can’t have CamelCase class names for extension classes due to extension loading mechanism</li>
</ul>
<p>这里主要展开说明前两点。</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/02/2014-02-09-nova-v3-api-extension-framework/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-09T14:40:31.000Z"><a href="/2014/01/2014-01-09-nova-scheduler-service-initialization/">Jan 9 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/2014-01-09-nova-scheduler-service-initialization/">NOVA Scheduler Service Initialization Process</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="NOVA-SCHEDULER-670d-52a1-542f-52a8-6d41-7a0b-">NOVA-SCHEDULER服务启动流程</h1>
<p><strong>前提</strong></p>
<ol>
<li>对Nova的整体结构已经有所理解</li>
<li>基于stable/havana分支</li>
<li>基于Redhat的RDO库进行的环境安装，基于CentOS 6.4</li>
<li>主机名为controller</li>
</ol>
<p><strong>内容</strong></p>
<ol>
<li>openstack-nova-scheduler服务启动流程</li>
<li>MessageQueue的相关知识及在scheduler服务启动过程中的涉及的行为</li>
</ol>
<h2 id="-6267-884c-7ed3-679c-">执行结果</h2>
<p>根据之前对Noah系统结构的理解，在scheduler启动过程中，会和MessageQueue交互，创建相应的Exchange和Consumer。</p>
<p>启动前的MessageQueue的状态：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="comment">#rabbitmqctl list_exchanges name type durable internal</span>
Listing exchanges <span class="keyword">...</span>
	direct	true	false
amq.direct	direct	true	false
amq.fanout	fanout	true	false
amq.headers	headers	true	false
amq.match	headers	true	false
amq.rabbitmq.log	topic	true	false
amq.rabbitmq.trace	topic	true	false
amq.topic	topic	true	false
...done.

<span class="comment">#rabbitmqctl list_bindings source_name source_kind destination_name destination_kind routing_key</span>
Listing bindings <span class="keyword">...</span>
...done.

<span class="comment">#rabbitmqctl list_connections pid name  port host peer_port peer_host state channels protocol</span>
Listing connections <span class="keyword">...</span>
...done.

<span class="comment">#rabbitmqctl list_channels pid connection name number consumer_count</span>
Listing channels <span class="keyword">...</span>
...done.

<span class="comment">#rabbitmqctl list_consumers</span>
Listing consumers <span class="keyword">...</span>
...done.
</pre></td></tr></table></figure>

<p>由上可知，在Scheduler启动前，只有RabbitMQ-Server默认创建的一些exchange，而binding、connection、channel和consumer均为空。</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/01/2014-01-09-nova-scheduler-service-initialization/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2014-01-09T14:40:31.000Z"><a href="/2014/01/2014-01-09-nova-api-service-initialization/">Jan 9 2014</a></time>
      
      
  
    <h1 class="title"><a href="/2014/01/2014-01-09-nova-api-service-initialization/">NOVA API Service Initialization Process</a></h1>
  

    </header>
    <div class="entry">
      
        <h1 id="NOVA-API-670d-52a1-542f-52a8-6d41-7a0b-">NOVA-API服务启动流程</h1>
<p><strong>前提</strong></p>
<ol>
<li>对Nova的整体结构已经有所理解</li>
<li>基于stable/havana分支</li>
<li>基于Redhat的RDO库进行的环境安装，基于CentOS 6.4</li>
</ol>
<p><strong>内容</strong></p>
<ol>
<li>openstack-nova-api服务启动流程</li>
<li>Paste、Deploy、WSGI等相关知识</li>
</ol>
<h2 id="-6267-884c-7ed3-679c-">执行结果</h2>
<p>启动API服务时的命令为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="comment">service</span> <span class="comment">openstack</span><span class="literal">-</span><span class="comment">nova</span><span class="literal">-</span><span class="comment">api</span> <span class="comment">start</span>
</pre></td></tr></table></figure>

<p>启动成功后，查看系统进程，发现实际执行结果为一个nova-api父进程，同时其有三个nova-api子进程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
4
</pre></td><td class="code"><pre>nova <span class="number">3438</span> S <span class="number">0</span>:<span class="number">07</span> <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>python <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>nova<span class="attribute">-api</span> <span class="subst">--</span>logfile <span class="subst">/</span><span class="built_in">var</span><span class="subst">/</span><span class="keyword">log</span><span class="subst">/</span>nova<span class="subst">/</span>api<span class="built_in">.</span><span class="keyword">log</span>
nova <span class="number">3446</span> S <span class="number">0</span>:<span class="number">00</span> <span class="subst">\</span>_ <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>python <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>nova<span class="attribute">-api</span> <span class="subst">--</span>logfile <span class="subst">/</span><span class="built_in">var</span><span class="subst">/</span><span class="keyword">log</span><span class="subst">/</span>nova<span class="subst">/</span>api<span class="built_in">.</span><span class="keyword">log</span>
nova <span class="number">3447</span> S <span class="number">0</span>:<span class="number">00</span> <span class="subst">\</span>_ <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>python <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>nova<span class="attribute">-api</span> <span class="subst">--</span>logfile <span class="subst">/</span><span class="built_in">var</span><span class="subst">/</span><span class="keyword">log</span><span class="subst">/</span>nova<span class="subst">/</span>api<span class="built_in">.</span><span class="keyword">log</span>
nova <span class="number">3448</span> S <span class="number">0</span>:<span class="number">00</span> <span class="subst">\</span>_ <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>python <span class="subst">/</span>usr<span class="subst">/</span>bin<span class="subst">/</span>nova<span class="attribute">-api</span> <span class="subst">--</span>logfile <span class="subst">/</span><span class="built_in">var</span><span class="subst">/</span><span class="keyword">log</span><span class="subst">/</span>nova<span class="subst">/</span>api<span class="built_in">.</span><span class="keyword">log</span>
</pre></td></tr></table></figure>

<p>查看监听的端口，发现父进程nova-api同时监听了三个端口：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
2
3
</pre></td><td class="code"><pre><span class="title">tcp</span>        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8773</span>                <span class="number">0.0.0.0</span>:*                   LISTEN      <span class="number">3438</span>/python         
tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8774</span>                <span class="number">0.0.0.0</span>:*                   LISTEN      <span class="number">3438</span>/python         
tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0.0.0:8775</span>                <span class="number">0.0.0.0</span>:*                   LISTEN      <span class="number">3438</span>/python
</pre></td></tr></table></figure>

<h2 id="-4ee3-7801-8def-5f84-">代码路径</h2>
<h3 id="-4e3b-8981-8def-5f84-">主要路径</h3>
<p>服务启动脚本为/etc/init.d/openstack-nova-api，查看此脚本发现在启动服务时实际执行的是/usr/bin/nova-api,而/usr/bin/nova-api是一个python脚本，实际执行的是nova.cmd.api.main</p>
<p>nova.cmd.api.main的主要代码如下：</p>
<figure class="highlight lang-python"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>    launcher = service.process_launcher()
    <span class="keyword">for</span> api <span class="keyword">in</span> CONF.enabled_apis:
        should_use_ssl = api <span class="keyword">in</span> CONF.enabled_ssl_apis
        <span class="keyword">if</span> api == <span class="string">'ec2'</span>:
            server = service.WSGIService(api, use_ssl=should_use_ssl,
                                         max_url_len=<span class="number">16384</span>)
        <span class="keyword">else</span>:
            server = service.WSGIService(api, use_ssl=should_use_ssl)
        launcher.launch_service(server, workers=server.workers <span class="keyword">or</span> <span class="number">1</span>)
    launcher.wait()
</pre></td></tr></table></figure>

<p>首先生成一个nova.common.service.Processlauncher类型的launcher, 接着会根据配置中的enabled_apis列表值，依次生成相应的WSGIService:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre>server = service.WSGIService(<span class="keyword">...</span>)
</pre></td></tr></table></figure>

<p>然后通过launcher的launch_service方法，将上述的WSGIService和workers数量作为参数传入。</p>
<p>在luanch_service方法中，会根据传入的workers参数fork出相应个数的子进程，并在各个子进程中调用对应WSGIService的start方法，开始对外服务。</p>
<h3 id="-6d89-53ca-7684-914d-7f6e-">涉及的配置</h3>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2014/01/2014-01-09-nova-api-service-initialization/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-08-07T14:40:31.000Z"><a href="/2013/08/2013-08-07-virtual-disk-unmap-shrink/">Aug 7 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/08/2013-08-07-virtual-disk-unmap-shrink/">虚拟磁盘的空间回收: Virtual Disk UNMAP/Shrink</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="-95ee-9898-">问题</h2>
<p>在虚拟化场景下，瘦分配(Thin-provisioning)磁盘应用场景非常广泛。目前主流的虚拟磁盘镜像格式，如Dynamic VHD、Sparse Raw、Qcow2、VMDK等均只具有随着虚拟机读写而动态增长的能力，一般来说是按需每次分配一个固定大小的块，如VHD的块是2M为单位。</p>
<p>当Guest OS删除了文件，已经分配的空间在虚拟磁盘上可否进行空间回收呢？</p>
<p>空间回收主要包括两步，一是获取到可以回收的空间，二是在虚拟磁盘文件中对相应空间进行回收。</p>
<p>根据获取所需回收空间时虚拟磁盘的IO情况来讲，回收主要有在线回收和离线回收，在线和离线的区别在于虚拟磁盘是否在有Guest持续写IO的情况下进行空间回收。也即离线回收不单单指虚拟机关机情形下的回收，也包括虚拟磁盘只有读IO的情况（如虚拟磁盘为某个ROW快照的父镜像）。</p>
<p>就虚拟磁盘文件来说，空间回收的结果可以是如下两种</p>
<ol>
<li>在Host上实际占用的空间减少</li>
<li>在Host上实际占用的空间减少，但是后续Guest的写入可以复用之前需要回收的空间，从而使得虚拟磁盘文件不会随着Guest的写入立即分配新块</li>
</ol>
<p>下文首先分别对离线和在线可回收空间获取方法进行讨论，然后对虚拟磁盘文件的空间回收方式进行讨论，最后以Qemu当前的实现为例进行说明。</p>

      
    </div>
    <footer>
      
        
          <div class="alignleft">
            <a href="/2013/08/2013-08-07-virtual-disk-unmap-shrink/#more" class="more-link">Read More</a>
          </div>
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  

  <nav id="pagination">
  
  
    <a href="/archives/page/2/" class="alignright next">Next</a>
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:leiqzhang.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/Linux/">Linux</a><small>3</small></li>
  
    <li><a href="/categories/OpenStack/">OpenStack</a><small>5</small></li>
  
    <li><a href="/categories/VIM/">VIM</a><small>3</small></li>
  
    <li><a href="/categories/Virtualization/">Virtualization</a><small>16</small></li>
  
    <li><a href="/categories/WordPress/">WordPress</a><small>2</small></li>
  
    <li><a href="/categories/miscellaneous/">miscellaneous</a><small>1</small></li>
  
    <li><a href="/categories/web_dev/">web_dev</a><small>8</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">Tag Cloud</h3>
  <div class="entry">
    <a href="/tags/CIM/" style="font-size: 10.00px;">CIM</a><a href="/tags/CORS/" style="font-size: 10.00px;">CORS</a><a href="/tags/DBPM/" style="font-size: 10.00px;">DBPM</a><a href="/tags/Deploy/" style="font-size: 10.00px;">Deploy</a><a href="/tags/ELI/" style="font-size: 10.00px;">ELI</a><a href="/tags/IRC/" style="font-size: 10.00px;">IRC</a><a href="/tags/NUMA/" style="font-size: 10.00px;">NUMA</a><a href="/tags/Nova/" style="font-size: 16.00px;">Nova</a><a href="/tags/OPTIONS/" style="font-size: 10.00px;">OPTIONS</a><a href="/tags/Paste/" style="font-size: 10.00px;">Paste</a><a href="/tags/QEMU/" style="font-size: 20.00px;">QEMU</a><a href="/tags/RabbitMQ/" style="font-size: 10.00px;">RabbitMQ</a><a href="/tags/Stevedore/" style="font-size: 10.00px;">Stevedore</a><a href="/tags/WSGI/" style="font-size: 10.00px;">WSGI</a><a href="/tags/bfc/" style="font-size: 10.00px;">bfc</a><a href="/tags/block-stream/" style="font-size: 10.00px;">block-stream</a><a href="/tags/blockcopy/" style="font-size: 12.00px;">blockcopy</a><a href="/tags/cache/" style="font-size: 10.00px;">cache</a><a href="/tags/css/" style="font-size: 12.00px;">css</a><a href="/tags/dataplane/" style="font-size: 10.00px;">dataplane</a><a href="/tags/device-mapper/" style="font-size: 10.00px;">device-mapper</a><a href="/tags/ervernote/" style="font-size: 10.00px;">ervernote</a><a href="/tags/etag/" style="font-size: 10.00px;">etag</a><a href="/tags/eval/" style="font-size: 10.00px;">eval</a><a href="/tags/fdisk/" style="font-size: 10.00px;">fdisk</a><a href="/tags/fedora/" style="font-size: 10.00px;">fedora</a><a href="/tags/gpt/" style="font-size: 10.00px;">gpt</a><a href="/tags/greasemonkey/" style="font-size: 10.00px;">greasemonkey</a><a href="/tags/http/" style="font-size: 12.00px;">http</a><a href="/tags/isolinux/" style="font-size: 10.00px;">isolinux</a><a href="/tags/javascript/" style="font-size: 10.00px;">javascript</a><a href="/tags/libvirt/" style="font-size: 18.00px;">libvirt</a><a href="/tags/lighthttpd/" style="font-size: 10.00px;">lighthttpd</a><a href="/tags/lighttpd/" style="font-size: 10.00px;">lighttpd</a><a href="/tags/livecd/" style="font-size: 10.00px;">livecd</a><a href="/tags/mac/" style="font-size: 10.00px;">mac</a><a href="/tags/mbr/" style="font-size: 10.00px;">mbr</a><a href="/tags/md5sum/" style="font-size: 10.00px;">md5sum</a><a href="/tags/mysql/" style="font-size: 12.00px;">mysql</a><a href="/tags/oVirt/" style="font-size: 14.00px;">oVirt</a>
  </div>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=1&isWeibo=1&isFans=0&uid=1644437791&verifier=c45a1931&dpc=1"></iframe>


  <div class="widget tag">
<h3 class="title">友情链接</h3>
<ul class="entry">
<li><a href="http://blog.csdn.net/luo_brian" title="luo_brian">Luohao</a></li>
<li><a href="http://blog.csdn.net/defeattroy" title="木马屠城">Defeattroy</a></li>
<li><a href="http://www.smilgel.com/" title="听雨轩">MrSaxon</a></li>
<li><a href="http://lanbolee.com/blog/" title="博之博">Rambolee</a></li>
<li><a href="http://www.haoziyanwo.com/" title="耗子燕窝">浩子</a></li>
<li><a href="http://blog.csdn.net/u012815727" title="CloudOS">CloudOS</a></li>
</ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 leiqzhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'leiqzhang';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>