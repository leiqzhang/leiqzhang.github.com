<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>QEMU Block Fetures: Atomic Snapshot | Technology &amp; Life</title>
  <meta name="author" content="leiqzhang">
  
  <meta name="description" content="Virtualization Related Technologies">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="QEMU Block Fetures: Atomic Snapshot"/>
  <meta property="og:site_name" content="Technology &amp; Life"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Technology &amp; Life" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Technology &amp; Life</a></h1>
  <h2><a href="/">blog of leiqzhang</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-04-17T03:38:31.000Z"><a href="/2013/04/2013-04-17-qemu-block-features-atomic-snapshot/">Apr 17 2013</a></time>
      
      
  
    <h1 class="title">QEMU Block Fetures: Atomic Snapshot</h1>
  

    </header>
    <div class="entry">
      
        <h3>SnapshotsMultipleDevices</h3>
<ol>
<li><p>ref: <a href="http://wiki.qemu.org/Features/SnapshotsMultipleDevices#Atomic_Snapshots_of_Multiple_Devices">QEMU-Feature-SnapshotsMultipleDevices</a></p>
</li>
<li><p>QMP Steps</p>
<ul>
<li>[CMD] qemu [...] -qmp tcp:localhost:4444,server<ul>
<li>Start QMP on a TCP socket, so that telnet can be used</li>
<li>-qmp conflicts with &quot;-monitor&quot;</li>
</ul>
</li>
<li>[CMD] telnet localhost 4444<ul>
<li>Run telnet</li>
<li>Should see the QMP&#39;s greeting banner:<pre><code>{"QMP":{"version": {"qemu": {"micro": 50, "minor": 13, "major": 0}, "package": ""}, "capabilities": []}} </code></pre></li>
</ul>
</li>
<li>[QMP_INPUT] <ul>
<li>Make QMP enter command mode:<pre><code>{"execute": "qmp_capabilities"}</code></pre></li>
</ul>
</li>
<li>[QMP_INPUT]<ul>
<li>Query the device info:<pre><code>{"execute":"query-blockstats"} </code></pre>
or
<pre><code>{ "execute": "human-monitor-command", "arguments": { "command-line": "info block" } } </code></pre></li>
<li>Get the device info from the output</li>
</ul>
</li>
<li>[QMP_input]<ul>
<li>Atomic snapshot:<pre><code>
{ "execute": "transaction",
   "arguments": { 
       "actions": [
       { 'type': 'blockdev-snapshot-sync', 'data' : { "device": "drive0",
           "snapshot-file": "/pkgs/imgs/win2003.snap",
           "format": "qcow2" } },
       { 'type': 'blockdev-snapshot-sync', 'data' : { "device": "drive1",
           "snapshot-file": "/pkgs/imgs/data.snap",
           "format": "qcow2" } } 
       ] 
   } 
}</code></pre></li>
<li>View Result, will find the current <strong>device/backing_file/backing_file_depth</strong> have already changed:<pre><code>{ "execute": "human-monitor-command", "arguments": { "command-line": "info block" } } </code></pre></li>
<li>CMD Args:</li>
<li>type: the operation to perform. The only supported value is &quot;<strong>blockdev-snapshot-sync</strong>&quot;.</li>
<li>data: a dict which contents depand on the value of &quot;type&quot;</li>
<li>if type == &quot;blockdev-snapshot-sync&quot;:<ul>
<li>device: device name to snapshot ( can get from the <strong>info</strong> block command )</li>
<li>snapshto-file: name of new image file</li>
<li>format: format of new image ( support &quot;qed&quot;, &quot;qcow2&quot;, default &quot;qcow2&quot; )</li>
<li>mode: whether and how QEMU should create the snapshot file ( NewImageMode, optional, default &quot;absolute-paths&quot; ) ( Can set to &quot;existing&quot;, which means <del>do the <strong>internal snapshot</strong></del> use the file as snap )</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Libvirt Support
 1 Code</p>
<ul>
<li>Interface <strong>virDomainSnapshotCreateXML</strong> has a input arg <strong>flags</strong>, and can be set with <strong>VIR_DOMAIN_SNAPSHOT_CREATE_ATOMIC</strong> </li>
<li>With <strong>VIR_DOMAIN_SNAPSHOT_CREATE_ATOMIC</strong> libvirt guarantees that this command will not alter any disks unless the entire set of changes can be done atomically, making failure recovery simpler (note that it is still possible to fail after disks have changed, but only in the much rarer cases of running out of memory or disk space).
2 Steps</li>
<li>Create domain<ul>
<li>[LIBVIRT-INPUT] <pre><code>virsh create win2003.xml</code></pre></li>
<li>disks info:<pre><code>
      <disk type='file' device='disk'>
      <driver name='qemu' type='raw' cache='none'/>
      <source file='/pkgs/imgs/win2003.img'/>
      <target dev='vda' bus='virtio'/>
      </disk>
       <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2' cache='none'/>
      <source file='/pkgs/imgs/data.qcow2'/>
      <target dev='vdb' bus='virtio'/>
      </disk>
</code></pre></li>
</ul>
</li>
<li>Create Snapshot XML  <pre><code>
      <domainsnapshot>
        <description>Test Libvirt Snapshot-Create</description>
        <disks>
          <disk name='/pkgs/imgs/win2003.img'>
            <source file='/pkgs/imgs/w.snap'/>
          </disk>
          <disk name='/pkgs/imgs/data.qcow2'>
            <source file='/pkgs/imgs/d.snap'/>
          </disk>
        </disks>
      </domainsnapshot> 
  </code></pre></li>
<li>Create Atomic Snapshot<ul>
<li>[LIBVIRT-INPUT] <pre><code>virsh snapshot-create 3 --xmlfile ./snap.xml  --disk-only <strong>--atomic</strong></code></pre></li>
<li>[LIBVIRT-OUTPUT] <pre><code>Domain snapshot 1366295688 created from &#39;./snap.xml&#39;</code></pre></li>
<li>Reult Disk Info:<pre><code>
      <disk type='file' device='disk'>
        <driver name='qemu' type='qcow2' cache='none'/>
        <source file='/pkgs/imgs/w.snap'/>
        <target dev='vda' bus='virtio'/>
        <alias name='virtio-disk0'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>
      </disk>
      <disk type='file' device='disk'>
        <driver name='qemu' type='qcow2' cache='none'/>
        <source file='/pkgs/imgs/d.snap'/>
        <target dev='vdb' bus='virtio'/>
        <alias name='virtio-disk1'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
      </disk>
</code></pre></li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/QEMU/">QEMU</a>, <a href="/categories/QEMU/Virtualization/">Virtualization</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/qemu/">qemu</a>, <a href="/tags/kvm/">kvm</a>, <a href="/tags/libvirt/">libvirt</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:leiqzhang.com">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/HTTP/">HTTP</a><small>2</small></li>
  
    <li><a href="/categories/JavaScriptCSS/">JavaScript/CSS</a><small>2</small></li>
  
    <li><a href="/categories/LinuxUnix/">Linux/Unix</a><small>3</small></li>
  
    <li><a href="/categories/MySQL/">MySQL</a><small>2</small></li>
  
    <li><a href="/categories/MySQL/PHP/">PHP</a><small>1</small></li>
  
    <li><a href="/categories/PHP/">PHP</a><small>2</small></li>
  
    <li><a href="/categories/QEMU/">QEMU</a><small>9</small></li>
  
    <li><a href="/categories/QEMU/Virtualization/">Virtualization</a><small>9</small></li>
  
    <li><a href="/categories/WordPress/">WordPress</a><small>2</small></li>
  
    <li><a href="/categories/vim/">vim</a><small>3</small></li>
  
    <li><a href="/categories/virtualization/">virtualization</a><small>1</small></li>
  
    <li><a href="/categories/virtualization/vmware/">vmware</a><small>1</small></li>
  
    <li><a href="/categories/未分类/">未分类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/bfc/">bfc</a><small>1</small></li>
  
    <li><a href="/tags/cache-control/">cache-control</a><small>1</small></li>
  
    <li><a href="/tags/collapse/">collapse</a><small>1</small></li>
  
    <li><a href="/tags/css/">css</a><small>1</small></li>
  
    <li><a href="/tags/dataplane/">dataplane</a><small>1</small></li>
  
    <li><a href="/tags/ervernote/">ervernote</a><small>1</small></li>
  
    <li><a href="/tags/etag/">etag</a><small>1</small></li>
  
    <li><a href="/tags/expires/">expires</a><small>1</small></li>
  
    <li><a href="/tags/float/">float</a><small>1</small></li>
  
    <li><a href="/tags/greasemonkey/">greasemonkey</a><small>1</small></li>
  
    <li><a href="/tags/hasLayout/">hasLayout</a><small>1</small></li>
  
    <li><a href="/tags/http/">http</a><small>2</small></li>
  
    <li><a href="/tags/javascript/">javascript</a><small>1</small></li>
  
    <li><a href="/tags/kvm/">kvm</a><small>9</small></li>
  
    <li><a href="/tags/last-modified/">last-modified</a><small>1</small></li>
  
    <li><a href="/tags/libvirt/">libvirt</a><small>8</small></li>
  
    <li><a href="/tags/lighthttpd/">lighthttpd</a><small>1</small></li>
  
    <li><a href="/tags/linux/">linux</a><small>1</small></li>
  
    <li><a href="/tags/mac/">mac</a><small>1</small></li>
  
    <li><a href="/tags/margin/">margin</a><small>1</small></li>
  
    <li><a href="/tags/md5sum/">md5sum</a><small>1</small></li>
  
    <li><a href="/tags/mysql/">mysql</a><small>2</small></li>
  
    <li><a href="/tags/patch/">patch</a><small>1</small></li>
  
    <li><a href="/tags/pdo/">pdo</a><small>1</small></li>
  
    <li><a href="/tags/perf/">perf</a><small>1</small></li>
  
    <li><a href="/tags/permalink/">permalink</a><small>1</small></li>
  
    <li><a href="/tags/php/">php</a><small>2</small></li>
  
    <li><a href="/tags/position/">position</a><small>1</small></li>
  
    <li><a href="/tags/post/">post</a><small>1</small></li>
  
    <li><a href="/tags/proxy/">proxy</a><small>1</small></li>
  
    <li><a href="/tags/qemu/">qemu</a><small>9</small></li>
  
    <li><a href="/tags/rewrite/">rewrite</a><small>1</small></li>
  
    <li><a href="/tags/scsi/">scsi</a><small>1</small></li>
  
    <li><a href="/tags/site-memory/">site memory</a><small>1</small></li>
  
    <li><a href="/tags/soap/">soap</a><small>1</small></li>
  
    <li><a href="/tags/sql/">sql</a><small>1</small></li>
  
    <li><a href="/tags/svn/">svn</a><small>1</small></li>
  
    <li><a href="/tags/tip/">tip</a><small>1</small></li>
  
    <li><a href="/tags/tree_conflict/">tree_conflict</a><small>1</small></li>
  
    <li><a href="/tags/vim/">vim</a><small>3</small></li>
  
    <li><a href="/tags/virtio/">virtio</a><small>1</small></li>
  
    <li><a href="/tags/vmware/">vmware</a><small>1</small></li>
  
    <li><a href="/tags/vpn/">vpn</a><small>1</small></li>
  
    <li><a href="/tags/wget/">wget</a><small>1</small></li>
  
    <li><a href="/tags/wordpress/">wordpress</a><small>2</small></li>
  
  </ul>
</div>


  

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 leiqzhang
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'leiqzhang';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>